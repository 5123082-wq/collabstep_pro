<!-- GitHub Copilot / AI agents guidance for contributors and automated coding agents -->

# Короткие инструкции для AI-агентов

Цель: дать AI-агентам (Copilot, помощникам PR/вёрстки и т.д.) достаточно контекста, чтобы делать полезные изменения в этом репозитории без лишних вопросов.

Ключевая архитектура (big picture)

- Монорепозиторий под `pnpm` (root `package.json`). Основные пакеты лежат в `apps/`.
- `apps/web` — фронтенд на Next.js 14 (app-router). Команды: `pnpm --filter @collabverse/web dev|build|start`. Скрипты смотрите в `apps/web/package.json` и `apps/web/scripts/`.
- `apps/api` — TypeScript-модуль (экспорт через `src/index.ts`), внутренние репозитории и сервисы для backend-логики.
- Документы и дорожная карта: `docs/PLAN.md` (источник правды для стадий), `docs/adr/` — архитектурные решения.

Что важно знать при правках

- Перед локальной проверкой выполняйте `pnpm install` и `pnpm ensure-env` (скрипт `scripts/ensure-env.mjs`).
- Основные рабочие команды (root):
  - `pnpm dev` — запускает фронтенд в dev (фильтр: @collabverse/web).
  - `pnpm build` / `pnpm start` — prod сборка и запуск фронтенда.
  - `pnpm test` — unit тесты (Jest).
  - `pnpm test:e2e` — e2e (Playwright). Обратите внимание: скрипт билдит фронт перед запуском тестов.
  - `pnpm verify` — полный предрелизный набор (lint, typecheck, build, unit, e2e и проверки маршрутов).

Проектные конвенции и паттерны

- Фичи часто скрыты за фич-флагами и env-переменными. Посмотрите `config/feature-flags.ts`, `apps/web/lib/feature-flags.ts` и переменные окружения в `README.md` (`NAV_V1`, `AUTH_DEV`, `FIN_EXPENSES_STORAGE` и т.д.).
- Для временных/малых изменений предпочитайте фич-флаги, чтобы не ломать main.
- State в UI: Zod для схем (валидация моков), Zustand для локального состояния, компоненты в `apps/web/components/*`.
- Маршруты и проверки: `apps/web/scripts/check-app-routes.mjs` и `apps/web/scripts/verify-routes.mjs` — используйте их при изменении страниц/маршрутов.

Интеграции и внешние зависимости

- Vercel — целевая платформа для деплоя; используйте `pnpm vercel-build` или `scripts/run-vercel-build.mjs` для симуляции сборки.
- База/драйверы для расходов управляются через `FIN_EXPENSES_STORAGE` (`memory` | `db`). По умолчанию dev = memory; staging/prod — db.

Примеры конкретных задач и где смотреть

- Добавление страницы в Next.js: изменения в `apps/web/app/` и `apps/web/components/`. После изменений запустите `pnpm --filter @collabverse/web run check:routes`.
- Изменение API/репозитория: `apps/api/src/` — обновляйте экспорты и тесты.
- Feature flags: меняйте конфиг в `config/feature-flags.ts` и убедитесь, что значения отражены в `NEXT_PUBLIC_*` для фронтенда, если нужно.

Контракт для автоматически генерируемых изменений (коротко)

- Ввод: изменённые файлы в `apps/web` или `apps/api`.
- Вывод: рабочая сборка `pnpm build` без ошибок, пройденные unit-тесты и проверка маршрутов.
- Ошибки: type errors, лого-сообщения `console.error`/`console.warn` видимы в тестах и должны быть устранены или явно заглушены с комментарием в PR.

Частые крайние случаи (edge-cases)

- Изменения маршрутов Next.js без обновления `check-app-routes.mjs` → CI падает. Всегда запустить `pnpm --filter @collabverse/web run check:routes`.
- Локальные переменные окружения отсутствуют → некоторые фичи используют dev-auth (`AUTH_DEV`) и демо-аккаунты; запустите `pnpm ensure-env`.
- Миграции хранилища расходов: при переключении `FIN_EXPENSES_STORAGE=db` убедитесь, что интеграция доступна и данные инициализированы корректно (seed-скрипты удалены).

Где искать дополнительную документацию

- `docs/PLAN.md` — дорожная карта и описание этапов.
- `docs/guides/setup.md` — локальная настройка окружения.
- `docs/adr/` — архитектурные решения по ключевым частям.

Если создаёшь PR через AI-агента — включи в описание:

1. Короткий summary (что изменено и почему).
2. Команды, которые проверяли изменения (например: `pnpm --filter @collabverse/web build` + `pnpm test`).
3. Указание на фич-флаги (если изменяются) и предложения по значению в preview/staging.

Если какая-то часть неполна или требует ручной проверки, пометь PR как `WIP` и опиши, какие переменные окружения/секреты нужны для полного тестирования.

---

## КРИТИЧЕСКИ ВАЖНО: Правила работы с CI и PR

**Приоритет №1: Прохождение CI проверок**

Главная цель — не допускать падения GitHub Actions job `build-test` при открытии pull request.

CI на GitHub запускает следующие команды (см. `.github/workflows/ci.yml`):

1. `pnpm install --frozen-lockfile`
2. `pnpm ensure-env`
3. `npx playwright install --with-deps`
4. `pnpm -w lint`
5. `pnpm -w typecheck`
6. `pnpm -w test`
7. `pnpm docs:lint`
8. `pnpm docs:links`

### Обязательные правила поведения для AI-агентов:

- **Всегда считать прохождение этих команд приоритетом №1.**
- **Каждый раз, когда пользователь просит:**
  - подготовить PR,
  - написать команды для коммита/пуша,
  - «можно ли это пушить», «готово ли к PR» и т.п.,
    — **сначала предполагается, что НУЖНО локально прогнать проверки.**

- **В ответах вначале всегда предлагай блок вида:**

  ```
  Локальные проверки перед пушем:
  pnpm install --frozen-lockfile
  pnpm ensure-env
  npx playwright install
  pnpm -w lint
  pnpm -w typecheck
  pnpm -w test
  pnpm docs:lint
  pnpm docs:links
  ```

  А уже после этого — команды git (add/commit/push) или текст PR.

- **Если пользователь присылает лог ошибок из любой из этих команд, задача — В ПЕРВУЮ ОЧЕРЕДЬ исправлять код так, чтобы все команды проходили без ошибок.**
  - Не предлагать `git push` и не формировать PR-описание, пока ошибки логически не исправлены.

- **Если какие-то проверки зависят от переменных окружения или дополнительных шагов, напоминать об этом и явно прописывать необходимые команды/настройки.**

- **При запросе на создание PR или отправку на сервер — ВСЕГДА спрашивать: "Провести ли локальные проверки перед созданием PR?"**

### Оптимизация

Всегда оптимизировать ответы под то, чтобы код проходил:

- `pnpm -w lint`
- `pnpm -w typecheck`
- `pnpm -w test`
- `pnpm docs:lint`
- `pnpm docs:links`

без ошибок перед отправкой изменений на GitHub.

---

Если хотите, могу сократить или расширить этот документ и добавить примеры PR-описаний/чек-лист для CI. Напишите, какие разделы хотите уточнить.
