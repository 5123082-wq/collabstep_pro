# Полный анализ всех пользователей системы

## Методология анализа

Анализ проведен на основе:
1. Исходного кода (seed-файлы, инициализация демо-аккаунтов)
2. Констант тестовых пользователей
3. API регистрации
4. Репозиториев пользователей (база данных и память)

## Категории пользователей

### 1. Тестовые администраторы

**Критерии определения:**
- ID равен `TEST_ADMIN_USER_ID` (`00000000-0000-0000-0000-000000000001`)
- Email равен `admin.demo@collabverse.test`
- Создаются через `ensureDemoAccountsInitialized()` или seed-скрипты
- Имеют предсказуемый UUID для стабильности тестирования

**Найденные тестовые администраторы:**

#### 1.1. Алина Админ
- **ID**: `00000000-0000-0000-0000-000000000001`
- **Email**: `admin.demo@collabverse.test`
- **Имя**: Алина Админ
- **Должность**: Руководитель продукта
- **Отдел**: Продукт
- **Локация**: Москва
- **Роли**: `productAdmin`, `featureAdmin`
- **Статус**: Активен
- **Пароль**: `admin.demo` (или значение из `DEMO_ADMIN_PASSWORD`)
- **Источники создания**:
  - `apps/web/lib/auth/init-demo-accounts.ts` (строки 26-34)
  - `apps/api/src/data/memory.ts` (строки 56-62)
  - `scripts/seed-demo-users.ts` (строки 22-26)
- **Константа**: `TEST_ADMIN_USER_ID`

---

### 2. Тестовые пользователи

**Критерии определения:**
- ID входит в список тестовых ID (`TEST_USER_ID`, `TEST_FINANCE_USER_ID`, `TEST_DESIGNER_USER_ID`)
- Email заканчивается на `@collabverse.test`
- Создаются через `ensureDemoAccountsInitialized()` или seed-скрипты
- Имеют предсказуемые UUID для стабильности тестирования

**Найденные тестовые пользователи:**

#### 2.1. Игорь Участник
- **ID**: `00000000-0000-0000-0000-000000000002`
- **Email**: `user.demo@collabverse.test`
- **Имя**: Игорь Участник
- **Должность**: Менеджер проектов
- **Отдел**: Операции
- **Локация**: Санкт-Петербург
- **Роли**: `viewer`
- **Статус**: Активен
- **Пароль**: `user.demo` (или значение из `DEMO_USER_PASSWORD`)
- **Источники создания**:
  - `apps/web/lib/auth/init-demo-accounts.ts` (строки 44-52)
  - `apps/api/src/data/memory.ts` (строки 64-70)
  - `scripts/seed-demo-users.ts` (строки 15-20)
- **Константа**: `TEST_USER_ID`

#### 2.2. Мария Финансы
- **ID**: `00000000-0000-0000-0000-000000000003`
- **Email**: `finance.pm@collabverse.test`
- **Имя**: Мария Финансы
- **Должность**: Финансовый контролёр
- **Отдел**: Финансы
- **Локация**: Москва
- **Роли**: `financeAdmin`, `betaTester`
- **Статус**: Активен
- **Пароль**: `finance.pm`
- **Источники создания**:
  - `apps/web/lib/auth/init-demo-accounts.ts` (строки 86-94)
  - `apps/api/src/data/memory.ts` (строки 72-78)
- **Константа**: `TEST_FINANCE_USER_ID`

#### 2.3. Диана Дизайн
- **ID**: `00000000-0000-0000-0000-000000000004`
- **Email**: `designer.demo@collabverse.test`
- **Имя**: Диана Дизайн
- **Должность**: Ведущий дизайнер
- **Отдел**: Дизайн
- **Локация**: Екатеринбург
- **Роли**: `betaTester`
- **Статус**: Приглашён (`invited`)
- **Пароль**: `designer.demo`
- **Источники создания**:
  - `apps/web/lib/auth/init-demo-accounts.ts` (строки 65-73)
  - `apps/api/src/data/memory.ts` (строки 80-86)
- **Константа**: `TEST_DESIGNER_USER_ID`

---

### 3. AI-агенты

**Критерии определения:**
- Email заканчивается на `@collabverse.ai`
- Имеют флаг `isAI: true`
- Создаются через `AIAgentsRepository`

**Найденные AI-агенты:**

#### 3.1. AI Ассистент
- **Email**: `ai.assistant@collabverse.ai`
- **Имя**: AI Ассистент
- **Должность**: AI-ассистент с OpenAI
- **Тип агента**: `assistant`
- **Поведение**: Автоматически отвечает на упоминания, короткие ответы
- **Область действия**: `public`
- **Создан**: Системой
- **Источники создания**:
  - `apps/api/src/repositories/ai-agents-repository.ts` (строки 28-46)
  - `scripts/reset-ai-agents.ts` (строки 23-39)

**Примечание:** В документации `USERS_ANALYSIS.md` упоминаются также:
- `ai.reviewer@collabverse.ai` (AI Ревьюер)
- `ai.reminder@collabverse.ai` (AI Напоминатель)
- `ai.summarizer@collabverse.ai` (AI Суммаризатор)

Эти агенты упоминаются в методе `deleteOldTestAgents()` (`apps/api/src/repositories/ai-agents-repository.ts`, строки 234-237), но в текущем коде они не создаются автоматически при инициализации. Они могут быть созданы вручную через UI (`/app/ai-hub`) или API (`/api/pm/ai-agents`).

---

### 4. Пользователи, зарегистрированные через форму

**Критерии определения:**
- Email НЕ заканчивается на `@collabverse.test` или `@collabverse.ai`
- ID НЕ входит в список тестовых ID
- Созданы через API `/api/auth/register`
- Имеют `passwordHash`
- Получают случайный UUID (если ID не указан явно)

**Процесс регистрации:**
1. Пользователь заполняет форму на `/register`
2. Форма отправляет POST-запрос на `/api/auth/register`
3. API проверяет валидность данных
4. Проверяет, что email не зарезервирован для демо-аккаунтов
5. Создает пользователя через `usersRepository.create()`
6. Возвращает редирект на страницу входа

**Код регистрации:**
- `apps/web/app/api/auth/register/route.ts` (строки 78-83)
- `apps/web/app/(marketing)/register/register-form.tsx` (строки 137-148)

**Ограничения:**
- Нельзя зарегистрировать email `admin.demo@collabverse.test` или `user.demo@collabverse.test`
- Минимальная длина пароля: 6 символов
- Email должен быть валидным

**Для определения реальных пользователей:**
Запустите скрипт `scripts/analyze-all-users.ts` для получения актуального списка всех пользователей в системе.

---

## Сводная таблица

| Категория | Количество | Email-паттерн | ID-паттерн |
|-----------|------------|--------------|------------|
| Тестовые администраторы | 1 | `admin.demo@collabverse.test` | `00000000-0000-0000-0000-000000000001` |
| Тестовые пользователи | 3 | `*.demo@collabverse.test`, `finance.pm@collabverse.test` | `00000000-0000-0000-0000-00000000000[2-4]` |
| AI-агенты | 1+ (может быть больше) | `*@collabverse.ai` | Email используется как ID |
| Зарегистрированные через форму | N (динамически) | Любой валидный email, кроме `@collabverse.test` и `@collabverse.ai` | Случайный UUID |

---

## Файлы, связанные с созданием пользователей

### Seed-файлы и инициализация:
1. `scripts/seed-demo-users.ts` - создает базовых демо-пользователей
2. `apps/web/lib/auth/init-demo-accounts.ts` - инициализирует демо-аккаунты с паролями
3. `apps/api/src/data/memory.ts` - предустановленные пользователи в памяти

### API регистрации:
1. `apps/web/app/api/auth/register/route.ts` - обработка регистрации через форму
2. `apps/web/app/(marketing)/register/register-form.tsx` - форма регистрации

### Репозитории:
1. `apps/api/src/repositories/users-repository.ts` - репозиторий для памяти
2. `apps/api/src/repositories/users-db-repository.ts` - репозиторий для базы данных
3. `apps/api/src/repositories/ai-agents-repository.ts` - создание AI-агентов

### Константы:
1. `apps/api/src/data/memory.ts` - константы тестовых ID
2. `apps/api/src/index.ts` - экспорт констант

---

## Как использовать скрипт анализа

Для получения актуального списка всех пользователей в системе:

```bash
cd /Users/macbookaleks/Documents/GitHub/collabstep-new-3
npx tsx scripts/analyze-all-users.ts
```

Скрипт выведет:
- Всех тестовых администраторов
- Всех тестовых пользователей
- Всех AI-агентов
- Всех пользователей, зарегистрированных через форму
- Сводную статистику

---

## Важные замечания

1. **Тестовые пользователи** имеют предсказуемые UUID для стабильности тестирования
2. **Зарегистрированные пользователи** получают случайные UUID
3. **AI-агенты** используют email в качестве ID
4. Система может работать как с базой данных, так и с памятью (в зависимости от конфигурации)
5. Демо-аккаунты автоматически инициализируются при первом использовании API регистрации или входа

---

## Дата анализа

Анализ проведен на основе кода по состоянию на момент создания документа.

