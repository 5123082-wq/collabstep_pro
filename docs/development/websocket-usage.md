# Использование WebSocket

## Режимы работы

### 1. Без WebSocket сервера (по умолчанию)

Если переменная `NEXT_PUBLIC_WS_URL` не указана, приложение работает через **polling fallback**:

- ✅ Все функции работают нормально
- ✅ Обновления происходят через polling интервалы:
  - Чат: каждые 30 секунд
  - Уведомления: каждые 60 секунд
  - Комментарии: при действиях пользователя
  - Задачи: через обычные события браузера
- ⚠️ Нет мгновенных обновлений в реальном времени
- ⚠️ Изменения других пользователей видны с задержкой

**Никаких дополнительных действий не требуется** — просто не указывайте `NEXT_PUBLIC_WS_URL`.

### 2. С WebSocket сервером (для production)

Для включения real-time обновлений:

1. **Запустите WebSocket сервер:**
   ```bash
   cd apps/api
   pnpm dev:ws
   ```

2. **Добавьте переменную окружения в `.env.local`:**
   ```env
   NEXT_PUBLIC_WS_URL=http://localhost:8080
   ```

3. **Перезапустите Next.js приложение**

Теперь все обновления происходят мгновенно через WebSocket, с fallback на polling при недоступности сервера.

## Переменные окружения

### `NEXT_PUBLIC_WS_URL`
URL WebSocket сервера. Если не указан, WebSocket отключен.

**Примеры:**
- `http://localhost:8080` — локальная разработка
- `wss://ws.example.com` — production (WebSocket Secure)

### `NEXT_PUBLIC_WS_ENABLED`
Явное включение/отключение WebSocket. По умолчанию WebSocket включен, если указан `NEXT_PUBLIC_WS_URL`.

**Значения:**
- `true`, `1`, `on` — включить WebSocket
- `false`, `0`, `off` — отключить WebSocket (даже если указан URL)

## Проверка работы

### Без WebSocket сервера:
- В консоли браузера: `[WebSocket] WebSocket disabled or URL not configured, using polling fallback`
- Обновления работают через polling интервалы

### С WebSocket сервером:
- В консоли браузера: `[WebSocket] Connected`
- Обновления происходят мгновенно
- При недоступности сервера автоматически переключается на polling

## Отладка

Если WebSocket не работает:

1. Проверьте, запущен ли сервер: `pnpm --filter @collabverse/api dev:ws`
2. Проверьте переменную окружения: `NEXT_PUBLIC_WS_URL`
3. Проверьте консоль браузера на ошибки подключения
4. Убедитесь, что порт 8080 не занят другим процессом

## Производительность

- **С WebSocket:** мгновенные обновления, меньше нагрузка на сервер
- **Без WebSocket:** обновления через polling, больше HTTP запросов, но проще в настройке

