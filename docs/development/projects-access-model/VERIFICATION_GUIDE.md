# Итоги реализации новой модели доступа и инструкция по проверке

## 1. Что было реализовано

Мы успешно завершили реализацию бэкенд-части новой модели доступа, включающей организации, исполнителей и двухэтапную систему приглашений в проекты.

### Основные компоненты:
1.  **Организации (`Organizations`)**:
    *   Возможность создавать организации (закрытые и открытые).
    *   Управление участниками и ролями (`owner`, `admin`, `member`).
2.  **Исполнители (`Performers`)**:
    *   Профили исполнителей со специализацией, навыками и портфолио.
    *   Публичный каталог исполнителей (API).
3.  **Проекты (Новая модель)**:
    *   Новая таблица проектов в БД (переход от in-memory хранилища).
    *   Связь проектов с организациями.
4.  **Система приглашений (Invites)**:
    *   **Двухэтапный доступ**: Приглашение -> Предпросмотр (Preview) -> Заявка (Pending Approval) -> Одобрение (Approved) -> Полный доступ.
    *   Поддержка приглашений по Email и через Ссылку.

---

## 2. Изменения в Базе Данных

Были добавлены следующие таблицы (миграция `0001_chemical_lake.sql`):

*   `organizations` — сущность организации.
*   `organization_members` — участники организаций.
*   `organization_invites` — приглашения в организации.
*   `performer_profiles` — профили для каталога.
*   `projects` — новая таблица проектов.
*   `project_members` — участники проектов.
*   `project_invites` — приглашения в проекты.

---

## 3. Новые API Endpoints

Все эндпоинты находятся по пути `/api/...`.

| Группа | Метод | URL | Описание |
| :--- | :--- | :--- | :--- |
| **Profile** | GET/POST | `/api/me/performer-profile` | Управление своим профилем исполнителя |
| **Org** | GET/POST | `/api/organizations` | Список моих организаций / Создание |
| **Org** | POST | `/api/organizations/[id]/invites` | Создать приглашение в организацию |
| **Catalog** | GET | `/api/performers` | Поиск исполнителей (публичный) |
| **Projects** | GET/POST | `/api/projects` | Список проектов / Создание (новая модель) |
| **Invites** | GET | `/api/projects/invites/[token]` | **Предпросмотр** проекта по токену |
| **Invites** | POST | `/api/projects/invites/[token]/accept` | Принять приглашение (стать кандидатом) |
| **Invites** | POST | `/api/projects/[id]/invites/[invId]/approve` | Одобрить кандидата (владельцем) |

---

## 4. Инструкция по проверке (Ручное тестирование API)

Так как пользовательский интерфейс (UI) для этих функций еще не реализован, проверку можно выполнить через **Postman**, **Insomnia** или **cURL**.

> **Важно**: Для выполнения запросов вам понадобится активная сессия (cookie `authjs.session-token` или `demo-session`). Самый простой способ — запустить проект, войти в систему через UI, открыть DevTools -> Network, скопировать любой запрос и использовать его заголовки.

### Сценарий 1: Создание организации

```bash
curl -X POST http://localhost:3000/api/organizations \
  -H "Content-Type: application/json" \
  -H "Cookie: ...ваши куки..." \
  -d '{
    "name": "Моя Студия",
    "type": "open",
    "description": "Тестовая организация"
  }'
```

### Сценарий 2: Создание профиля исполнителя

```bash
curl -X POST http://localhost:3000/api/me/performer-profile \
  -H "Content-Type: application/json" \
  -H "Cookie: ...ваши куки..." \
  -d '{
    "specialization": "Backend Developer",
    "skills": ["Node.js", "PostgreSQL"],
    "isPublic": true
  }'
```

После этого можно проверить, появился ли профиль в каталоге:
`GET http://localhost:3000/api/performers`

### Сценарий 3: Полный цикл приглашения в проект

1.  **Создайте проект** (в новой модели):
    ```bash
    POST /api/projects
    { "name": "Secret Project", "organizationId": "ID_ВАШЕЙ_ОРГАНИЗАЦИИ" }
    ```
    *Сохраните полученный `id` проекта.*

2.  **Создайте приглашение** (как владелец):
    ```bash
    POST /api/projects/ID_ПРОЕКТА/invites
    { "source": "link" }
    ```
    *В ответе придет объект `invite` с полем `token`.*

3.  **Проверьте предпросмотр** (можно даже без авторизации или с другого аккаунта):
    ```bash
    GET /api/projects/invites/TOKEN_ПРИГЛАШЕНИЯ
    ```
    *Вы должны получить `preview` с названием и описанием проекта, но без внутренних данных.*

4.  **Примите приглашение** (от лица другого пользователя):
    ```bash
    POST /api/projects/invites/TOKEN_ПРИГЛАШЕНИЯ/accept
    ```
    *Статус приглашения изменится на `pending_owner_approval`.*

5.  **Одобрите участие** (от лица владельца):
    ```bash
    POST /api/projects/ID_ПРОЕКТА/invites/ID_ПРИГЛАШЕНИЯ/approve
    ```
    *Теперь пользователь официально добавлен в таблицу `project_members`.*

---

## 5. Дальнейшие шаги

1.  **Frontend**: Реализовать страницы создания организаций, профилей и лендинг для приема приглашений.
2.  **Миграция**: Перенести существующие проекты из старого хранилища в новую таблицу `projects`.

