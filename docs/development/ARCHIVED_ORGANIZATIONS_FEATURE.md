# Функционал архивных организаций

## Обзор

Организации не удаляются из системы, а архивируются для возможности восстановления. Данные об организации остаются в базе данных, но организация переводится в статус `archived` или `deleted`.

## Требования

### 1. Бизнес-правила

- **Прямое удаление организаций запрещено** - организации должны быть закрыты через процесс архивации
- **Данные сохраняются** - все данные организации остаются в БД для возможности восстановления
- **Восстановление возможно** - администраторы могут восстановить архивную организацию
- **Доступ ограничен** - архивные организации не видны в обычном интерфейсе, только в специальных разделах

### 2. Статусы организаций

- `active` - активная организация (по умолчанию)
- `archived` - архивированная организация (данные сохранены, можно восстановить)
- `deleted` - удаленная организация (данные сохранены, восстановление требует подтверждения)

## Архитектура

### 1. База данных

#### Таблица `organization`

Уже существует поле `status` с типом `organizationStatusEnum`:
- `active`
- `archived`
- `deleted`

Дополнительные поля (если нужно):
- `closedAt: timestamp` - дата закрытия организации
- `closureReason: text` - причина закрытия (опционально)
- `archivedBy: text` - ID пользователя, который архивировал организацию

#### Таблица `organization_archive`

Уже существует таблица для хранения снимков архивных организаций:
- `id`
- `organizationId`
- `organizationName`
- `snapshot: jsonb` - снимок данных организации
- `createdAt`
- `archivedBy`

### 2. API Endpoints

#### Организации (обычные пользователи)

```
GET /api/organizations
- Возвращает только активные организации (status = 'active')
- Фильтрует архивные и удаленные организации

GET /api/organizations/archived
- Возвращает архивные организации текущего пользователя
- Требует аутентификации
- Показывает только организации, где пользователь был участником
```

#### Админ-панель

```
GET /api/admin/organizations/archived
- Возвращает все архивные организации
- Требует прав администратора
- Поддерживает пагинацию и фильтрацию

GET /api/admin/organizations/deleted
- Возвращает удаленные организации
- Требует прав администратора

POST /api/admin/organizations/:id/restore
- Восстанавливает архивную организацию
- Требует прав администратора
- Валидирует, что организация существует и имеет статус 'archived' или 'deleted'

POST /api/admin/organizations/:id/archive
- Архивирует активную организацию
- Требует прав администратора
- Создает снимок данных через organization-closure-service

DELETE /api/admin/organizations/:id
- НЕ ДОЛЖЕН удалять организацию из БД
- Должен переводить в статус 'deleted' или 'archived'
- Использовать organization-closure-service для архивации
```

### 3. UI Компоненты

#### Вкладка "Организация" (обычные пользователи)

**Новый раздел: "Архивные организации"**

```
/app/(app)/organization/archived/page.tsx
```

Компоненты:
- `ArchivedOrganizationsList` - список архивных организаций пользователя
- `ArchivedOrganizationCard` - карточка архивной организации
  - Название организации
  - Дата архивации
  - Причина архивации (если есть)
  - Кнопка "Запросить восстановление" (отправляет запрос администратору)

Функционал:
- Показывает только организации, где пользователь был участником
- Фильтрация по дате архивации
- Поиск по названию организации
- Информация о возможности восстановления

#### Админ-панель

**Новый раздел: "Архивные организации"**

```
/app/(app)/admin/organizations/archived/page.tsx
/app/(app)/admin/organizations/deleted/page.tsx
```

Компоненты:
- `AdminArchivedOrganizationsList` - список всех архивных организаций
- `AdminArchivedOrganizationCard` - карточка с деталями
  - Название организации
  - Владелец организации
  - Дата архивации
  - Причина архивации
  - Количество проектов (на момент архивации)
  - Кнопка "Восстановить"
  - Кнопка "Просмотреть снимок" (показывает данные из organization_archive)

Функционал:
- Показывает все архивные/удаленные организации
- Фильтрация по статусу (archived/deleted)
- Фильтрация по дате архивации
- Поиск по названию, владельцу
- Восстановление организаций
- Просмотр снимков архивных данных
- Экспорт списка архивных организаций

**Детальная страница архивной организации:**

```
/app/(app)/admin/organizations/archived/[id]/page.tsx
```

Компоненты:
- `ArchivedOrganizationDetails` - детальная информация
- `ArchivedOrganizationSnapshot` - просмотр снимка данных
- `RestoreOrganizationModal` - модальное окно восстановления
  - Подтверждение восстановления
  - Выбор, какие данные восстанавливать (проекты, задачи, участники)
  - Предупреждение о возможных конфликтах

## План разработки

### Этап 1: Backend API (Приоритет: Высокий)

1. **Обновить `organizationsRepository`**
   - Метод `listForUser()` - фильтровать только активные организации
   - Новый метод `listArchivedForUser(userId)` - архивные организации пользователя
   - Новый метод `listArchived()` - все архивные организации (для админа)
   - Новый метод `restore(id)` - восстановление организации

2. **Создать API endpoints**
   - `GET /api/organizations/archived` - архивные организации пользователя
   - `GET /api/admin/organizations/archived` - все архивные организации
   - `GET /api/admin/organizations/deleted` - удаленные организации
   - `POST /api/admin/organizations/:id/restore` - восстановление организации
   - `POST /api/admin/organizations/:id/archive` - архивация организации

3. **Обновить `organization-closure-service`**
   - Убедиться, что при архивации создается снимок в `organization_archive`
   - Добавить метод `restoreOrganization(organizationId)` для восстановления

4. **Валидация и безопасность**
   - Проверка прав доступа (только админы могут восстанавливать)
   - Валидация статуса организации перед восстановлением
   - Логирование всех операций архивации/восстановления

### Этап 2: UI для обычных пользователей (Приоритет: Средний)

1. **Создать страницу архивных организаций**
   - `app/(app)/organization/archived/page.tsx`
   - Компонент `ArchivedOrganizationsList`
   - Компонент `ArchivedOrganizationCard`

2. **Добавить навигацию**
   - Добавить ссылку "Архивные организации" в раздел "Организация"
   - Показывать счетчик архивных организаций (если есть)

3. **Функционал запроса восстановления**
   - Кнопка "Запросить восстановление"
   - Отправка запроса администратору (можно через уведомления или отдельную таблицу запросов)

### Этап 3: UI для админ-панели (Приоритет: Высокий)

1. **Создать страницы админ-панели**
   - `app/(app)/admin/organizations/archived/page.tsx`
   - `app/(app)/admin/organizations/deleted/page.tsx`
   - `app/(app)/admin/organizations/archived/[id]/page.tsx`

2. **Компоненты админ-панели**
   - `AdminArchivedOrganizationsList`
   - `AdminArchivedOrganizationCard`
   - `ArchivedOrganizationDetails`
   - `ArchivedOrganizationSnapshot`
   - `RestoreOrganizationModal`

3. **Добавить навигацию в админ-панель**
   - Добавить раздел "Архивные организации" в меню админки
   - Показывать счетчик архивных организаций

4. **Функционал восстановления**
   - Модальное окно восстановления с подтверждением
   - Выбор данных для восстановления
   - Обработка конфликтов (например, если проект с таким именем уже существует)

### Этап 4: Тестирование и документация (Приоритет: Средний)

1. **Unit тесты**
   - Тесты для `organizationsRepository.restore()`
   - Тесты для API endpoints
   - Тесты для `organization-closure-service.restoreOrganization()`

2. **E2E тесты**
   - Тест архивации организации
   - Тест восстановления организации
   - Тест просмотра архивных организаций

3. **Документация**
   - Обновить API документацию
   - Создать руководство для администраторов
   - Обновить документацию по организации-closure-service

## Технические детали

### Восстановление организации

При восстановлении организации нужно:

1. **Проверить статус** - организация должна быть в статусе `archived` или `deleted`
2. **Восстановить статус** - установить `status = 'active'`
3. **Восстановить участников** - восстановить записи в `organization_member` (если были удалены)
4. **Восстановить проекты** - восстановить проекты организации (если были удалены)
5. **Обновить снимок** - пометить снимок в `organization_archive` как восстановленный

### Обработка конфликтов

При восстановлении могут возникнуть конфликты:

- **Проект с таким именем уже существует** - предложить переименовать или пропустить
- **Участник уже в другой организации** - предложить добавить в обе или выбрать одну
- **Данные изменились** - показать предупреждение о возможных несоответствиях

### Производительность

- Использовать пагинацию для списков архивных организаций
- Кэшировать счетчики архивных организаций
- Ленивая загрузка снимков данных (только при запросе)

## Связанные файлы

### Backend
- `apps/api/src/repositories/organizations-repository.ts` - репозиторий организаций
- `apps/api/src/services/closure/organization-closure-service.ts` - сервис закрытия организаций
- `apps/api/src/db/schema.ts` - схема БД (таблицы `organization`, `organization_archive`)
- `apps/web/app/api/organizations/archived/route.ts` - API архивных организаций
- `apps/web/app/api/admin/organizations/archived/route.ts` - API админ-панели

### Frontend
- `apps/web/app/(app)/organization/archived/page.tsx` - страница архивных организаций пользователя
- `apps/web/app/(app)/admin/organizations/archived/page.tsx` - страница архивных организаций админа
- `apps/web/components/organizations/ArchivedOrganizationsList.tsx` - компонент списка
- `apps/web/components/organizations/ArchivedOrganizationCard.tsx` - компонент карточки
- `apps/web/components/admin/organizations/RestoreOrganizationModal.tsx` - модальное окно восстановления

## Приоритеты разработки

1. **Критично**: Backend API для восстановления организаций
2. **Важно**: UI админ-панели для управления архивными организациями
3. **Желательно**: UI для обычных пользователей (просмотр архивных организаций)
4. **Опционально**: Расширенный функционал восстановления с выбором данных

## Заметки

- Организации никогда не удаляются физически из БД
- Все операции архивации/восстановления логируются
- Администраторы могут просматривать снимки архивных данных
- Восстановление требует подтверждения администратора

