# Stage K: Диаграмма Ганта и зависимости задач

## Статус: ✅ ЗАВЕРШЁН

**Приоритет:** P1 (Высокий)  
**Оценка времени:** 12-15 дней  
**Зависимости:** Нет (но желательно после Stage H для комментариев)

---

## Цель этапа

Реализовать диаграмму Ганта для визуализации задач на временной шкале с зависимостями между задачами, возможностью изменения сроков через перетаскивание и отображением критического пути проекта.

---

## Задачи этапа

### Задача 1: API endpoints для зависимостей задач

**Описание:** Создать API endpoints для управления зависимостями между задачами.

**Файлы:**

- `apps/web/app/api/pm/tasks/[id]/dependencies/route.ts` (новый)

**Требования:**

- `GET /api/pm/tasks/[id]/dependencies` — получить зависимости задачи
- `POST /api/pm/tasks/[id]/dependencies` — создать зависимость
- `DELETE /api/pm/tasks/[id]/dependencies/[depId]` — удалить зависимость
- Валидация циклических зависимостей
- Проверка доступа к проекту

**Пример структуры:**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getAuthFromRequest, getProjectRole } from '@/lib/api/finance-access';
import {
  tasksRepository,
  taskDependenciesRepository,
  projectsRepository,
} from '@collabverse/api';
import { jsonError, jsonOk } from '@/lib/api/http';

export async function GET(
  req: NextRequest,
  { params }: { params: { id: string } }
): Promise<NextResponse> {
  const auth = getAuthFromRequest(req);
  if (!auth) {
    return jsonError('UNAUTHORIZED', { status: 401 });
  }

  const task = tasksRepository.findById(params.id);
  if (!task) {
    return jsonError('NOT_FOUND', { status: 404 });
  }

  const role = getProjectRole(task.projectId, auth.userId);
  if (role === 'viewer') {
    return jsonError('ACCESS_DENIED', { status: 403 });
  }

  const dependencies = taskDependenciesRepository.listByTask(params.id);
  return jsonOk({ dependencies });
}

export async function POST(
  req: NextRequest,
  { params }: { params: { id: string } }
): Promise<NextResponse> {
  // Проверка доступа
  // Валидация body (blockerTaskId, type)
  // Проверка циклических зависимостей
  // Создание зависимости
}
```

**Критерии готовности:**

- [x] Все endpoints работают
- [x] Валидация циклических зависимостей работает
- [x] Проверка доступа работает
- [x] Написаны unit тесты

---

### Задача 2: Валидация циклических зависимостей

**Описание:** Реализовать функцию проверки циклических зависимостей.

**Файл:** `apps/web/lib/pm/dependency-validator.ts` (новый)

**Требования:**

- Функция `hasCycle(taskId, blockerTaskId)` — проверка цикла
- Использование графа зависимостей для поиска циклов
- Возврат ошибки при обнаружении цикла

**Пример структуры:**

```typescript
export function hasCycle(
  taskId: string,
  blockerTaskId: string,
  dependencies: TaskDependency[]
): boolean {
  // Построение графа зависимостей
  // Поиск пути от blockerTaskId до taskId
  // Если путь найден — цикл обнаружен
}
```

**Критерии готовности:**

- [x] Функция корректно обнаруживает циклы
- [x] Написаны unit тесты для различных сценариев

---

### Задача 3: Выбор библиотеки для диаграммы Ганта

**Описание:** Выбрать и установить библиотеку для диаграммы Ганта.

**Варианты:**

- `dhtmlx-gantt` — популярная библиотека с хорошей документацией
- `@bryntum/gantt` — профессиональная библиотека (платная)
- Собственная реализация на SVG/Canvas

**Рекомендация:** Начать с `dhtmlx-gantt` (бесплатная версия) или создать простую реализацию на SVG.

**Требования:**

- Установка библиотеки (если используется готовая)
- Или создание базовой структуры компонента

**Критерии готовности:**

- [x] Библиотека установлена или структура создана (собственная реализация на SVG)
- [x] Понимание API библиотеки

---

### Задача 4: Компонент диаграммы Ганта

**Описание:** Создать компонент диаграммы Ганта для отображения задач.

**Файл:** `apps/web/components/pm/TasksGanttView.tsx` (новый)

**Требования:**

- Отображение задач как полос на временной шкале
- Отображение зависимостей стрелками между задачами
- Перетаскивание задач для изменения сроков
- Масштабирование временной шкалы (дни/недели/месяцы)
- Фильтрация задач
- Отображение критического пути

**Пример структуры:**

```typescript
'use client';

import { useEffect, useState } from 'react';

type TasksGanttViewProps = {
  projectId: string;
  tasks: Task[];
};

export default function TasksGanttView({ projectId, tasks }: TasksGanttViewProps) {
  const [dependencies, setDependencies] = useState([]);
  const [scale, setScale] = useState<'day' | 'week' | 'month'>('week');

  useEffect(() => {
    loadDependencies();
  }, [tasks]);

  const loadDependencies = async () => {
    // Загрузка зависимостей для всех задач
  };

  const handleTaskDrag = async (taskId: string, newStart: Date, newEnd: Date) => {
    // Обновление сроков задачи через API
  };

  return (
    <div>
      {/* Контролы масштабирования */}
      {/* Диаграмма Ганта */}
    </div>
  );
}
```

**Критерии готовности:**

- [x] Компонент отображает задачи на временной шкале
- [x] Можно изменять сроки через перетаскивание
- [x] Зависимости отображаются стрелками
- [x] Работает масштабирование временной шкалы

---

### Задача 5: Утилиты для диаграммы Ганта

**Описание:** Создать утилиты для работы с диаграммой Ганта.

**Файл:** `apps/web/lib/pm/gantt-utils.ts` (новый)

**Требования:**

- Функция вычисления критического пути проекта
- Функция преобразования задач в формат библиотеки Ганта
- Функции для работы с зависимостями

**Пример структуры:**

```typescript
export function calculateCriticalPath(
  tasks: Task[],
  dependencies: TaskDependency[]
): string[] {
  // Алгоритм поиска критического пути
  // Возврат массива ID задач критического пути
}

export function transformTasksForGantt(
  tasks: Task[],
  dependencies: TaskDependency[]
): GanttTask[] {
  // Преобразование задач в формат библиотеки Ганта
}
```

**Критерии готовности:**

- [x] Утилиты работают корректно
- [x] Написаны unit тесты

---

### Задача 6: Обновление сроков через диаграмму

**Описание:** Реализовать обновление сроков задач при перетаскивании на диаграмме.

**Требования:**

- Обработка события перетаскивания задачи
- Отправка запроса на обновление задачи через API
- Оптимистичное обновление UI
- Обработка ошибок

**Критерии готовности:**

- [x] Сроки обновляются при перетаскивании
- [x] Изменения сохраняются через API
- [x] Обрабатываются ошибки

---

### Задача 7: Отображение критического пути

**Описание:** Визуализировать критический путь проекта на диаграмме.

**Требования:**

- Вычисление критического пути
- Выделение задач критического пути цветом
- Выделение зависимостей критического пути

**Критерии готовности:**

- [x] Критический путь вычисляется корректно
- [x] Критический путь визуально выделен на диаграмме

---

### Задача 8: Интеграция в страницу проекта

**Описание:** Добавить вкладку "Гант" на странице проекта.

**Файл:** `apps/web/app/(app)/pm/projects/[id]/page.tsx` (обновить)

**Требования:**

- Добавить вкладку "Гант"
- Интегрировать компонент TasksGanttView
- Синхронизация с Kanban и календарём (обновление при изменении задач)

**Критерии готовности:**

- [x] Вкладка "Гант" добавлена
- [x] Компонент интегрирован
- [x] Синхронизация с другими представлениями работает

---

### Задача 9: Фильтрация задач на диаграмме

**Описание:** Добавить возможность фильтрации задач на диаграмме Ганта.

**Требования:**

- Фильтры по статусу, исполнителю, приоритету
- Применение фильтров к отображаемым задачам
- Сохранение состояния фильтров

**Критерии готовности:**

- [x] Фильтры работают
- [x] Состояние фильтров сохраняется

---

### Задача 10: Unit тесты

**Описание:** Написать unit тесты для зависимостей и утилит Ганта.

**Файлы:**

- `apps/web/tests/unit/task-dependencies.spec.ts` (новый)
- `apps/web/tests/unit/gantt-utils.spec.ts` (новый)

**Требования:**

- Тесты для валидации зависимостей
- Тесты для вычисления критического пути
- Тесты для преобразования данных

**Критерии готовности:**

- [x] Все функции покрыты unit тестами

---

### Задача 11: E2E тесты

**Описание:** Написать E2E тесты для диаграммы Ганта.

**Файл:** `apps/web/tests/e2e/gantt.spec.ts` (новый)

**Требования:**

- Тест создания зависимости
- Тест изменения сроков через перетаскивание
- Тест валидации циклических зависимостей

**Критерии готовности:**

- [x] Основные сценарии покрыты E2E тестами

---

## Критерии готовности этапа (DoD)

- [x] Диаграмма Ганта отображает задачи на временной шкале
- [x] Можно изменять сроки через перетаскивание
- [x] Зависимости отображаются стрелками между задачами
- [x] Валидация циклических зависимостей работает
- [x] Критический путь вычисляется и отображается
- [x] Синхронизация с другими представлениями (Kanban, календарь) работает
- [x] Все API endpoints работают и покрыты тестами
- [x] Unit и E2E тесты проходят успешно

---

## Файлы для создания/изменения

### Новые файлы

- `apps/web/app/api/pm/tasks/[id]/dependencies/route.ts`
- `apps/web/lib/pm/dependency-validator.ts`
- `apps/web/components/pm/TasksGanttView.tsx`
- `apps/web/lib/pm/gantt-utils.ts`
- `apps/web/tests/unit/task-dependencies.spec.ts`
- `apps/web/tests/unit/gantt-utils.spec.ts`
- `apps/web/tests/e2e/gantt.spec.ts`

### Изменённые файлы

- `apps/web/app/(app)/pm/projects/[id]/page.tsx` — добавить вкладку "Гант"

### Зависимости (package.json)

- Добавить библиотеку для диаграммы Ганта (если используется готовая)

---

## Отчёт о проделанной работе

**⚠️ ВАЖНО:** После завершения этапа необходимо заполнить отчёт в мастер-документе `docs/development/projects-master-guide.md` в разделе "Отчёты по этапам".

**Шаблон отчёта:**

```markdown

### Stage K: Диаграмма Ганта и зависимости задач

**Дата завершения:** YYYY-MM-DD  
**Статус:** ✅ ЗАВЕРШЁН

#### Выполненные задачи

- [Список выполненных задач]

#### Созданные файлы

- [Список новых файлов]

#### Изменённые файлы

- [Список изменённых файлов]

#### Проблемы и решения

- [Описание проблем и их решений]

#### Метрики

- Покрытие тестами: X%
- Время выполнения: X дней
- Количество багов: X

#### Следующие шаги

- [Что делать дальше]
```

---

## Заметки и рекомендации

1. **Библиотека Ганта:** Рекомендуется начать с простой реализации на SVG или использовать бесплатную библиотеку. Профессиональные библиотеки могут быть дорогими.

2. **Критический путь:** Используйте алгоритм поиска критического пути (например, алгоритм на основе топологической сортировки).

3. **Производительность:** Для большого количества задач используйте виртуализацию и оптимизацию рендеринга.

4. **Зависимости:** Убедитесь, что валидация циклических зависимостей работает корректно перед сохранением.

5. **Синхронизация:** Изменения на диаграмме Ганта должны синхронизироваться с Kanban и календарём через обновление задач через API.

---

## Следующие шаги после завершения

После завершения Stage K можно переходить к:

- **Stage L:** WebSocket (независимо)
- **Stage M:** AI-ассистент (независимо)
- **Stage N:** Расширенная функциональность AI (зависит от Stage M и K)

---

## История изменений

- **2025-01-XX** — Создан чеклист Stage K
