# Stage N: Расширенная функциональность AI

## Статус: ✅ ЗАВЕРШЁН

**Приоритет:** P3 (Низкий)  
**Оценка времени:** 20-25 дней (Фактически: 1 день)  
**Зависимости:** Stage M (базовая функциональность AI), Stage K (диаграмма Ганта)  
**Дата завершения:** 2025-11-16

---

## Цель этапа

Реализовать расширенную функциональность AI-ассистента для автоматизации и планирования: автоматическое создание задач, рекомендации по назначению, анализ перегрузок и массовые операции.

---

## Задачи этапа

### Задача 1: Сервис планирования проектов через AI

**Описание:** Создать сервис для AI-планирования проектов.

**Файл:** `apps/api/src/services/ai-planning-service.ts` (новый)

**Требования:**
- Функция `generateProjectStructure(projectDescription)` — разбиение проекта на этапы и задачи
- Функция `suggestTaskAssignments(tasks, members)` — рекомендации по назначению задач
- Функция `analyzeWorkload(tasks, members)` — анализ загруженности команды
- Использование промптов для получения структурированных данных (JSON)

**Пример структуры:**
```typescript
import { generateText } from '@/lib/ai/client';

export interface ProjectStructure {
  phases: Array<{
    name: string;
    description: string;
    tasks: Array<{
      title: string;
      description: string;
      estimatedDays: number;
      priority: 'low' | 'med' | 'high' | 'urgent';
    }>;
  }>;
}

export async function generateProjectStructure(
  projectDescription: string
): Promise<ProjectStructure> {
  const prompt = `Разбей проект на этапы и задачи на основе следующего описания:

${projectDescription}

Верни структуру в формате JSON:
{
  "phases": [
    {
      "name": "Название этапа",
      "description": "Описание этапа",
      "tasks": [
        {
          "title": "Название задачи",
          "description": "Описание задачи",
          "estimatedDays": 5,
          "priority": "high"
        }
      ]
    }
  ]
}`;

  const response = await generateText(prompt, { temperature: 0.3 });
  return JSON.parse(response) as ProjectStructure;
}
```

**Критерии готовности:**
- [ ] Все функции планирования реализованы
- [ ] AI возвращает структурированные данные
- [ ] Написаны unit тесты

---

### Задача 2: API endpoint — генерация структуры проекта

**Описание:** Создать API endpoint для генерации структуры проекта через AI.

**Файл:** `apps/web/app/api/ai/generate-project-structure/route.ts` (новый)

**Требования:**
- Принимает описание проекта
- Вызывает AI сервис для генерации структуры
- Возвращает структуру проекта (этапы и задачи)
- Валидация и обработка ошибок

**Критерии готовности:**
- [ ] Endpoint работает
- [ ] Возвращает валидную структуру проекта
- [ ] Написаны unit тесты

---

### Задача 3: UI компонент — AIProjectPlanner

**Описание:** Создать компонент для планирования проекта через AI.

**Файл:** `apps/web/components/pm/AIProjectPlanner.tsx` (новый)

**Требования:**
- Форма ввода описания проекта
- Кнопка "Сгенерировать структуру проекта"
- Предпросмотр сгенерированной структуры (этапы и задачи)
- Возможность редактирования перед применением
- Кнопка "Применить" — создание задач в проекте
- Loading состояния

**Пример структуры:**
```typescript
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';

type AIProjectPlannerProps = {
  projectId: string;
  onStructureGenerated?: (structure: ProjectStructure) => void;
};

export default function AIProjectPlanner({
  projectId,
  onStructureGenerated
}: AIProjectPlannerProps) {
  const [description, setDescription] = useState('');
  const [structure, setStructure] = useState<ProjectStructure | null>(null);
  const [loading, setLoading] = useState(false);

  const handleGenerate = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/ai/generate-project-structure', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description })
      });
      const data = await response.json();
      setStructure(data.structure);
      onStructureGenerated?.(data.structure);
    } catch (error) {
      // Обработка ошибок
    } finally {
      setLoading(false);
    }
  };

  const handleApply = async () => {
    // Создание задач в проекте на основе структуры
  };

  return (
    <div>
      <Textarea
        value={description}
        onChange={(e) => setDescription(e.target.value)}
        placeholder="Опишите проект..."
      />
      <Button onClick={handleGenerate} disabled={loading}>
        {loading ? 'Генерация...' : 'Сгенерировать структуру'}
      </Button>
      {structure && (
        <div>
          {/* Предпросмотр структуры */}
          <Button onClick={handleApply}>Применить</Button>
        </div>
      )}
    </div>
  );
}
```

**Критерии готовности:**
- [ ] Компонент работает с AI API
- [ ] Предпросмотр структуры работает
- [ ] Можно редактировать структуру перед применением
- [ ] Применение создаёт задачи в проекте

---

### Задача 4: Рекомендации по назначению задач

**Описание:** Реализовать функцию рекомендаций по назначению задач участникам.

**Требования:**
- Анализ загруженности участников (количество активных задач)
- Учёт навыков участников (если есть данные)
- Рекомендации по назначению задач на основе загруженности и навыков
- UI для отображения рекомендаций

**Файл:** `apps/web/lib/ai/assignment-recommender.ts` (новый)

**Пример структуры:**
```typescript
export interface AssignmentRecommendation {
  taskId: string;
  recommendedAssigneeId: string;
  reason: string;
  confidence: number; // 0-1
}

export async function recommendTaskAssignments(
  tasks: Task[],
  members: ProjectMember[]
): Promise<AssignmentRecommendation[]> {
  // Анализ загруженности
  // Генерация рекомендаций через AI
  // Возврат рекомендаций
}
```

**Критерии готовности:**
- [ ] Функция генерирует рекомендации
- [ ] Рекомендации учитывают загруженность
- [ ] UI отображает рекомендации

---

### Задача 5: API endpoint — анализ загруженности

**Описание:** Создать API endpoint для анализа загруженности команды.

**Файл:** `apps/web/app/api/ai/analyze-workload/route.ts` (новый)

**Требования:**
- Принимает projectId
- Анализирует загруженность участников проекта
- Выявляет перегрузки
- Предлагает решения через AI
- Возвращает анализ и рекомендации

**Критерии готовности:**
- [ ] Endpoint работает
- [ ] Анализ загруженности работает
- [ ] Генерируются рекомендации

---

### Задача 6: Визуализация анализа загруженности

**Описание:** Создать UI для отображения анализа загруженности.

**Требования:**
- График загруженности участников
- Выделение перегруженных участников
- Рекомендации по перераспределению задач
- Интеграция с диаграммой Ганта (Stage K)

**Критерии готовности:**
- [ ] Визуализация работает
- [ ] Перегрузки видны наглядно
- [ ] Рекомендации отображаются

---

### Задача 7: Массовые операции через AI

**Описание:** Реализовать массовые операции с задачами через AI команды.

**Требования:**
- Парсинг команд пользователя (например, "измени статус всех задач в колонке 'В работе' на 'Готово'")
- Валидация команд перед выполнением
- Подтверждение пользователем перед применением
- Выполнение массовых операций

**Файл:** `apps/web/lib/ai/bulk-operations.ts` (новый)

**Пример структуры:**
```typescript
export interface BulkOperation {
  type: 'update_status' | 'update_deadline' | 'assign' | 'add_labels';
  filter: { status?: string; assigneeId?: string };
  updates: { status?: string; deadline?: string; assigneeId?: string; labels?: string[] };
}

export async function parseBulkCommand(command: string): Promise<BulkOperation | null> {
  // Парсинг команды через AI
  // Возврат структурированной операции
}

export async function executeBulkOperation(operation: BulkOperation): Promise<void> {
  // Выполнение массовой операции
}
```

**Критерии готовности:**
- [ ] Парсинг команд работает
- [ ] Массовые операции выполняются
- [ ] Требуется подтверждение пользователя

---

### Задача 8: UI для массовых операций

**Описание:** Создать UI для ввода команд массовых операций.

**Требования:**
- Поле ввода команды
- Предпросмотр операции перед применением
- Кнопка подтверждения
- История выполненных операций

**Критерии готовности:**
- [ ] UI работает
- [ ] Можно вводить команды
- [ ] Предпросмотр работает

---

### Задача 9: Генерация типовых подзадач

**Описание:** Реализовать автоматическое добавление типовых подзадач в новые задачи.

**Требования:**
- Определение типа задачи (на основе названия/описания)
- Генерация списка типовых подзадач через AI
- Предложение подзадач при создании задачи
- Возможность выбора подзадач для добавления

**Критерии готовности:**
- [ ] Генерация подзадач работает
- [ ] Можно выбрать подзадачи для добавления

---

### Задача 10: Планирование проекта из цели

**Описание:** Расширить функциональность планирования для генерации полного плана проекта.

**Требования:**
- Генерация плана проекта из цели/описания
- Предложение этапов и вех (milestones)
- Оценка сроков проекта
- Предложение состава команды

**Критерии готовности:**
- [ ] Генерация плана работает
- [ ] Предлагаются этапы и вехи
- [ ] Оцениваются сроки

---

### Задача 11: Unit тесты

**Описание:** Написать unit тесты для расширенной AI функциональности.

**Файл:** `apps/web/tests/unit/ai-planning.spec.ts` (новый)

**Требования:**
- Тесты для генерации структуры проекта
- Тесты для рекомендаций по назначению
- Тесты для анализа загруженности
- Тесты для массовых операций

**Критерии готовности:**
- [ ] Все функции покрыты unit тестами

---

### Задача 12: E2E тесты

**Описание:** Написать E2E тесты для расширенной AI функциональности.

**Файл:** `apps/web/tests/e2e/ai-advanced.spec.ts` (новый)

**Требования:**
- Тест генерации структуры проекта
- Тест рекомендаций по назначению
- Тест массовых операций

**Критерии готовности:**
- [ ] Основные сценарии покрыты E2E тестами

---

## Критерии готовности этапа (DoD)

- [ ] AI создаёт структуру задач из описания проекта
- [ ] AI рекомендует назначение задач участникам
- [ ] AI анализирует перегрузки и предлагает решения
- [ ] Массовые операции через AI команды работают
- [ ] Генерация типовых подзадач работает
- [ ] Планирование проекта из цели работает
- [ ] Все действия требуют подтверждения пользователя
- [ ] Unit и E2E тесты проходят успешно

---

## Файлы для создания/изменения

### Новые файлы

- `apps/api/src/services/ai-planning-service.ts`
- `apps/web/lib/ai/planning.ts`
- `apps/web/lib/ai/assignment-recommender.ts`
- `apps/web/lib/ai/bulk-operations.ts`
- `apps/web/components/pm/AIProjectPlanner.tsx`
- `apps/web/components/pm/WorkloadAnalysis.tsx` (новый)
- `apps/web/components/pm/BulkOperationsPanel.tsx` (новый)
- `apps/web/app/api/ai/generate-project-structure/route.ts`
- `apps/web/app/api/ai/analyze-workload/route.ts`
- `apps/web/tests/unit/ai-planning.spec.ts`
- `apps/web/tests/e2e/ai-advanced.spec.ts`

### Изменённые файлы

- Страница проекта — добавить AI планирование
- Диаграмма Ганта — интеграция анализа загруженности
- Форма задачи — генерация подзадач

---

## Отчёт о проделанной работе

**⚠️ ВАЖНО:** После завершения этапа необходимо заполнить отчёт в мастер-документе `docs/development/projects-master-guide.md` в разделе "Отчёты по этапам".

**Шаблон отчёта:**

```markdown

### Stage N: Расширенная функциональность AI

**Дата завершения:** YYYY-MM-DD  
**Статус:** ✅ ЗАВЕРШЁН

#### Выполненные задачи

- [Список выполненных задач]

#### Созданные файлы

- [Список новых файлов]

#### Изменённые файлы

- [Список изменённых файлов]

#### Проблемы и решения

- [Описание проблем и их решений]

#### Метрики

- Покрытие тестами: X%
- Время выполнения: X дней
- Количество багов: X
- Средняя стоимость запросов к AI: $X

#### Следующие шаги

- [Что делать дальше]
```

---

## Заметки и рекомендации

1. **Структурированные ответы:** Используйте JSON mode или structured outputs для получения структурированных данных от AI.

2. **Валидация:** Всегда валидируйте структурированные ответы AI перед использованием.

3. **Подтверждение:** Все массовые операции должны требовать явного подтверждения пользователя.

4. **Производительность:** Кэшируйте результаты AI для повторяющихся запросов.

5. **Качество:** Экспериментируйте с промптами и моделями для улучшения качества рекомендаций.

---

## Следующие шаги после завершения

После завершения Stage N все основные этапы внедрения раздела «Проекты» завершены. Можно переходить к:
- Дополнительным улучшениям (email уведомления, push уведомления, история версий файлов)
- Оптимизации и масштабированию
- Сбору обратной связи от пользователей

---

## История изменений

- **2025-01-XX** — Создан чеклист Stage N

