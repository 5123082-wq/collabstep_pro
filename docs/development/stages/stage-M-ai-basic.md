# Stage M: AI-ассистент (базовая функциональность)

## Статус: ✅ ЗАВЕРШЁН

**Приоритет:** P2 (Средний)  
**Оценка времени:** 15-20 дней  
**Зависимости:** Stage H, I, J (для работы с комментариями, уведомлениями, чатом)

---

## Цель этапа

Реализовать базовую функциональность AI-ассистента для помощи в управлении проектами: генерация описаний задач, суммирование комментариев, напоминания о дедлайнах и чат с AI в проекте.

---

## Задачи этапа

### Задача 1: Выбор провайдера LLM

**Описание:** Выбрать и настроить провайдера LLM для AI-ассистента.

**Варианты:**

- OpenAI (GPT-4, GPT-3.5)
- Anthropic (Claude)
- Локальная модель (Ollama, LM Studio)
- Другие провайдеры

**Рекомендация:** Начать с OpenAI API для быстрого старта, затем можно добавить поддержку других провайдеров.

**Требования:**

- Настройка API ключей в переменных окружения
- Выбор модели (например, GPT-3.5-turbo для начала)
- Настройка лимитов и rate limiting

**Критерии готовности:**

- [x] Провайдер выбран и настроен (OpenAI)
- [x] API ключи настроены безопасно
- [x] Тестовый запрос к API работает

---

### Задача 2: Базовый клиент для LLM

**Описание:** Создать базовый клиент для работы с LLM API.

**Файл:** `apps/web/lib/ai/client.ts` (новый)

**Требования:**

- Функция `generateText(prompt, options)` — генерация текста
- Обработка ошибок API
- Retry логика при ошибках
- Логирование запросов и ответов

**Пример структуры:**

```typescript
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function generateText(
  prompt: string,
  options: { maxTokens?: number; temperature?: number } = {}
): Promise<string> {
  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [{ role: 'user', content: prompt }],
      max_tokens: options.maxTokens ?? 500,
      temperature: options.temperature ?? 0.7,
    });

    return response.choices[0]?.message?.content ?? '';
  } catch (error) {
    console.error('AI API error:', error);
    throw error;
  }
}
```

**Критерии готовности:**

- [x] Клиент работает с выбранным провайдером
- [x] Обработка ошибок работает
- [x] Retry логика работает

---

### Задача 3: Шаблоны промптов

**Описание:** Создать библиотеку шаблонов промптов для различных задач.

**Файл:** `apps/web/lib/ai/prompts.ts` (новый)

**Требования:**

- Функция `generateTaskDescriptionPrompt(taskTitle, context)` — промпт для генерации описания задачи
- Функция `generateChecklistPrompt(taskTitle, description)` — промпт для генерации чек-листа
- Функция `summarizeCommentsPrompt(comments)` — промпт для суммирования комментариев
- Функция `chatPrompt(question, projectContext)` — промпт для чата с AI

**Пример структуры:**

```typescript
export function generateTaskDescriptionPrompt(
  taskTitle: string,
  context?: { projectName?: string; projectDescription?: string }
): string {
  return `Ты помощник по управлению проектами. Сгенерируй подробное описание для задачи "${taskTitle}".

${context?.projectName ? `Проект: ${context.projectName}` : ''}
${context?.projectDescription ? `Описание проекта: ${context.projectDescription}` : ''}

Создай структурированное описание задачи, включающее:
- Цель задачи
- Шаги выполнения
- Ожидаемый результат
- Критерии готовности

Описание:`;
}
```

**Критерии готовности:**

- [x] Все шаблоны промптов созданы
- [x] Промпты оптимизированы для получения качественных ответов
- [x] Промпты документированы

---

### Задача 4: Сервис AI для задач

**Описание:** Создать сервис для AI операций с задачами.

**Файл:** `apps/api/src/services/ai-service.ts` (новый)

**Требования:**

- Функция `generateTaskDescription(taskTitle, context)` — генерация описания задачи
- Функция `generateTaskChecklist(taskTitle, description)` — генерация чек-листа
- Функция `summarizeTaskComments(taskId, comments)` — суммирование комментариев задачи
- Валидация ответов AI перед возвратом

**Пример структуры:**

```typescript
import { generateText } from '@/lib/ai/client';
import {
  generateTaskDescriptionPrompt,
  generateChecklistPrompt,
} from '@/lib/ai/prompts';

export async function generateTaskDescription(
  taskTitle: string,
  context?: { projectName?: string }
): Promise<string> {
  const prompt = generateTaskDescriptionPrompt(taskTitle, context);
  const description = await generateText(prompt);

  // Валидация и очистка ответа
  return cleanAIResponse(description);
}

function cleanAIResponse(response: string): string {
  // Удаление лишних символов, форматирование
  return response.trim();
}
```

**Критерии готовности:**

- [x] Все функции AI для задач реализованы
- [x] Валидация ответов работает
- [x] Написаны unit тесты

---

### Задача 5: API endpoint — генерация описания задачи

**Описание:** Создать API endpoint для генерации описания задачи через AI.

**Файл:** `apps/web/app/api/ai/generate-description/route.ts` (новый)

**Требования:**

- Принимает taskTitle и опционально projectId
- Вызывает AI сервис для генерации описания
- Возвращает сгенерированное описание
- Обработка ошибок AI API

**Пример структуры:**

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getAuthFromRequest } from '@/lib/api/finance-access';
import { generateTaskDescription } from '@/api/src/services/ai-service';
import { jsonError, jsonOk } from '@/lib/api/http';

export async function POST(req: NextRequest) {
  const auth = getAuthFromRequest(req);
  if (!auth) {
    return jsonError('UNAUTHORIZED', { status: 401 });
  }

  const body = await req.json();
  const { taskTitle, projectId } = body;

  if (!taskTitle) {
    return jsonError('INVALID_REQUEST', { status: 400 });
  }

  try {
    const description = await generateTaskDescription(taskTitle, { projectId });
    return jsonOk({ description });
  } catch (error) {
    return jsonError('AI_SERVICE_ERROR', { status: 500 });
  }
}
```

**Критерии готовности:**

- [x] Endpoint работает и возвращает описание
- [x] Обработка ошибок работает
- [x] Написаны unit тесты

---

### Задача 6: API endpoint — суммирование комментариев

**Описание:** Создать API endpoint для суммирования комментариев задачи через AI.

**Файл:** `apps/web/app/api/ai/summarize-comments/route.ts` (новый)

**Требования:**

- Принимает taskId
- Получает комментарии задачи
- Вызывает AI для суммирования
- Возвращает сводку

**Критерии готовности:**

- [x] Endpoint работает
- [x] Суммирование комментариев работает корректно
- [x] Написаны unit тесты

---

### Задача 7: UI компонент — TaskAIActions

**Описание:** Создать компонент с AI действиями для задач.

**Файл:** `apps/web/components/pm/TaskAIActions.tsx` (новый)

**Требования:**

- Кнопка "Сгенерировать описание" — вызывает API и заполняет поле описания
- Кнопка "Сгенерировать чек-лист" — генерирует чек-лист для задачи
- Кнопка "Суммировать комментарии" — показывает сводку комментариев
- Loading состояния при генерации
- Обработка ошибок с toast уведомлениями

**Пример структуры:**

```typescript
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { toast } from '@/lib/ui/toast';

type TaskAIActionsProps = {
  taskId: string;
  taskTitle: string;
  onDescriptionGenerated?: (description: string) => void;
};

export default function TaskAIActions({
  taskId,
  taskTitle,
  onDescriptionGenerated
}: TaskAIActionsProps) {
  const [loading, setLoading] = useState(false);

  const handleGenerateDescription = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/ai/generate-description', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ taskTitle })
      });
      const data = await response.json();
      onDescriptionGenerated?.(data.description);
      toast('Описание сгенерировано', 'success');
    } catch (error) {
      toast('Ошибка генерации описания', 'warning');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <Button onClick={handleGenerateDescription} disabled={loading}>
        {loading ? 'Генерация...' : 'Сгенерировать описание'}
      </Button>
      {/* Другие кнопки AI */}
    </div>
  );
}
```

**Критерии готовности:**

- [x] Компонент работает с AI API
- [x] Loading состояния работают
- [x] Обработка ошибок работает

---

### Задача 8: Интеграция AI в форму задачи

**Описание:** Интегрировать AI действия в форму создания/редактирования задачи.

**Требования:**

- Добавить компонент TaskAIActions в форму задачи
- При генерации описания заполнять поле описания
- При генерации чек-листа добавлять его в описание или отдельное поле

**Критерии готовности:**

- [x] AI действия доступны в форме задачи
- [x] Генерация работает и заполняет поля

---

### Задача 9: Напоминания о дедлайнах через AI

**Описание:** Реализовать автоматическую проверку дедлайнов и генерацию уведомлений через AI.

**Требования:**

- Функция проверки задач с дедлайнами в ближайшие N дней
- Генерация персонализированных напоминаний через AI
- Интеграция с системой уведомлений (Stage I)
- Настройка интервала проверки

**Файл:** `apps/web/lib/ai/deadline-reminder.ts` (новый)

**Критерии готовности:**

- [x] Проверка дедлайнов работает
- [x] Генерируются персонализированные напоминания
- [x] Уведомления отправляются через систему уведомлений

---

### Задача 10: Чат с AI в проекте

**Описание:** Интегрировать AI в общий чат проекта для ответов на вопросы.

**Требования:**

- Определение сообщений, адресованных AI (например, начинающихся с "@ai" или "/ai")
- Генерация ответов AI на основе контекста проекта (задачи, участники, прогресс)
- Отображение ответов AI в чате как сообщений от виртуального участника
- Ограничение частоты запросов к AI

**Файлы для изменения:**

- `apps/web/components/pm/ProjectChat.tsx` — обработка сообщений для AI
- `apps/web/lib/ai/chat.ts` — логика чата с AI

**Пример структуры:**

```typescript
export async function generateChatResponse(
  question: string,
  projectContext: {
    projectId: string;
    tasks: Task[];
    members: ProjectMember[];
  }
): Promise<string> {
  const prompt = `Ты AI-ассистент проекта "${projectContext.projectId}".

Контекст проекта:
- Задач: ${projectContext.tasks.length}
- Участников: ${projectContext.members.length}

Вопрос пользователя: ${question}

Ответь на вопрос, используя контекст проекта.`;

  return await generateText(prompt);
}
```

**Критерии готовности:**

- [x] AI отвечает на вопросы в чате проекта
- [x] Ответы учитывают контекст проекта
- [x] Ограничение частоты запросов работает

---

### Задача 11: Ограничения и безопасность

**Описание:** Реализовать ограничения и проверки безопасности для AI.

**Требования:**

- Проверка прав доступа перед использованием AI
- Валидация ответов AI перед сохранением (проверка на недопустимый контент)
- Подтверждение действий AI пользователем (не автоматическое сохранение)
- Лимиты на количество запросов к AI (rate limiting)

**Критерии готовности:**

- [x] Проверка прав доступа работает
- [x] Валидация ответов работает
- [x] Все действия AI требуют подтверждения
- [x] Rate limiting работает

---

### Задача 12: UI компонент — AIAssistant

**Описание:** Создать отдельный компонент AI-ассистента для панели помощи.

**Файл:** `apps/web/components/pm/AIAssistant.tsx` (новый)

**Требования:**

- Панель для вопросов к AI
- История диалога
- Быстрые действия (генерация описания, суммирование и т.д.)
- Интеграция в right rail или отдельную панель

**Критерии готовности:**

- [x] Компонент работает
- [x] Можно задавать вопросы AI
- [x] История диалога сохраняется

---

### Задача 13: Unit тесты

**Описание:** Написать unit тесты для AI функциональности.

**Файл:** `apps/web/tests/unit/ai-service.spec.ts` (новый)

**Требования:**

- Тесты для генерации описаний
- Тесты для суммирования комментариев
- Тесты для валидации ответов
- Моки для AI API

**Критерии готовности:**

- [x] Все функции покрыты unit тестами

---

### Задача 14: E2E тесты

**Описание:** Написать E2E тесты для AI функциональности.

**Файл:** `apps/web/tests/e2e/ai-assistant.spec.ts` (новый)

**Требования:**

- Тест генерации описания задачи
- Тест суммирования комментариев
- Тест чата с AI

**Критерии готовности:**

- [x] Основные сценарии покрыты E2E тестами

---

### Задача 15: Типы и модель данных для AI-агентов

**Описание:** Расширить типы для поддержки виртуальных AI-агентов.

**Файлы для изменения:**

- `apps/api/src/types.ts` — добавить типы для AI-агентов

**Требования:**

- Расширить `WorkspaceUser` флагом `isAI?: boolean`
- Тип агента: `'assistant' | 'reviewer' | 'reminder' | 'summarizer'`
- Шаблоны ответов для каждого типа агента

**Критерии готовности:**

- [x] Типы для AI-агентов определены
- [x] WorkspaceUser расширен флагом isAI

---

### Задача 16: Repository для AI-агентов

**Описание:** Создать repository для управления AI-агентами.

**Файл:** `apps/api/src/repositories/ai-agents-repository.ts` (новый)

**Требования:**

- Методы: `create()`, `findById()`, `list()`, `listByProject()`
- Предустановленные агенты (assistant, reviewer, reminder)
- Инициализация агентов при первом использовании

**Критерии готовности:**

- [x] Repository создан с методами CRUD
- [x] Предустановленные агенты инициализируются

---

### Задача 17: API endpoint — управление AI-агентами проекта

**Описание:** Создать endpoint для добавления/удаления AI-агента в проект как участника.

**Файл:** `apps/web/app/api/pm/projects/[id]/ai-agents/route.ts` (новый)

**Требования:**

- POST — добавить агента в проект
- DELETE — удалить агента из проекта
- GET — список агентов проекта
- Проверка прав (только owner/admin может добавлять агентов)

**Критерии готовности:**

- [x] Endpoint добавляет агентов в проект
- [x] Endpoint возвращает список агентов проекта
- [x] Проверка прав работает

---

### Задача 18: Автоматические ответы AI-агентов

**Описание:** Реализовать логику автоматических ответов AI-агентов в чате и комментариях.

**Файл:** `apps/web/lib/ai/agent-responses.ts` (новый)

**Требования:**

- Определение упоминаний агентов (@ai-assistant, @ai-reviewer)
- Выбор шаблона ответа (случайный или по контексту)
- Отправка ответа от имени агента

**Критерии готовности:**

- [x] Определение упоминаний агентов работает
- [x] Автоматические ответы отправляются
- [x] Ответы используют шаблоны агентов

---

### Задача 19: Интеграция агентов в чат проекта

**Описание:** Интегрировать обработку упоминаний агентов в ProjectChat.

**Файл:** `apps/web/components/pm/ProjectChat.tsx` (обновить)

**Требования:**

- При отправке сообщения проверять упоминания агентов
- Вызывать `handleAgentMention()` после создания сообщения
- Отображать агентов в списке участников с пометкой [AI]

**Критерии готовности:**

- [x] Упоминания агентов обрабатываются в чате
- [x] Агенты отвечают автоматически

---

### Задача 20: UI компонент — управление AI-агентами проекта

**Описание:** Создать компонент для добавления/удаления AI-агентов в проект.

**Файл:** `apps/web/components/pm/ProjectAIAgents.tsx` (новый)

**Требования:**

- Список доступных агентов
- Список агентов в проекте
- Кнопки добавления/удаления
- Отображение типа и описания агента

**Критерии готовности:**

- [x] Компонент отображает агентов проекта
- [x] Можно добавлять/удалять агентов

---

### Задача 21: Назначение агентов на задачи

**Описание:** Позволить назначать AI-агентов на задачи как исполнителей.

**Требования:**

- В селекторе исполнителей показывать AI-агентов с пометкой [AI]
- При назначении агента на задачу агент может автоматически комментировать
- Агенты могут быть фильтром в списке задач

**Файлы для изменения:**

- Компонент выбора исполнителя задачи
- `apps/web/app/api/pm/tasks/route.ts` — разрешить назначение AI-агентов

**Критерии готовности:**

- [x] AI-агенты отображаются в селекторе исполнителей
- [x] Можно назначить агента на задачу
- [x] Агенты фильтруются в списке задач

---

### Задача 22: Автоматические действия агентов на задачах

**Описание:** Реализовать автоматические действия агентов при назначении на задачи.

**Файл:** `apps/web/lib/ai/agent-task-actions.ts` (новый)

**Требования:**

- При назначении агента на задачу — автоматический комментарий
- При изменении статуса задачи агентом — комментарий
- Напоминания о дедлайнах от агента-напоминателя

**Критерии готовности:**

- [x] Агенты комментируют при назначении на задачу
- [x] Агенты реагируют на изменения статуса

---

## Критерии готовности этапа (DoD)

- [x] AI генерирует описания задач и чек-листы
- [x] AI суммирует комментарии задач
- [x] AI отвечает на вопросы в чате проекта
- [x] AI генерирует напоминания о дедлайнах
- [x] Все действия AI требуют подтверждения пользователя
- [x] Валидация и безопасность работают
- [x] Rate limiting работает
- [x] Unit и E2E тесты проходят успешно
- [x] AI-агенты создаются и добавляются в проекты
- [x] Агенты отвечают на упоминания в чате стандартными сообщениями
- [x] Агенты могут быть назначены на задачи
- [x] Агенты автоматически комментируют при назначении
- [x] UI для управления агентами работает

---

## Файлы для создания/изменения

### Новые файлы:

- `apps/web/lib/ai/client.ts`
- `apps/web/lib/ai/prompts.ts`
- `apps/api/src/services/ai-service.ts`
- `apps/web/lib/ai/deadline-reminder.ts`
- `apps/web/lib/ai/chat.ts`
- `apps/web/app/api/ai/generate-description/route.ts`
- `apps/web/app/api/ai/summarize-comments/route.ts`
- `apps/web/components/pm/TaskAIActions.tsx`
- `apps/web/components/pm/AIAssistant.tsx`
- `apps/web/tests/unit/ai-service.spec.ts`
- `apps/web/tests/e2e/ai-assistant.spec.ts`
- `apps/api/src/repositories/ai-agents-repository.ts`
- `apps/web/lib/ai/agent-responses.ts`
- `apps/web/lib/ai/agent-task-actions.ts`
- `apps/web/app/api/pm/projects/[id]/ai-agents/route.ts`
- `apps/web/components/pm/ProjectAIAgents.tsx`

### Изменённые файлы:

- Форма создания/редактирования задачи — добавить TaskAIActions
- `apps/web/components/pm/ProjectChat.tsx` — интеграция AI чата и обработка упоминаний агентов
- Система уведомлений — интеграция AI напоминаний
- `apps/api/src/types.ts` — добавить типы для AI-агентов
- `apps/web/app/api/pm/tasks/route.ts` — разрешить назначение AI-агентов
- Компонент выбора исполнителя задачи — показывать AI-агентов

### Зависимости (package.json):

- `openai` или другой пакет для выбранного провайдера

### Переменные окружения:

- `OPENAI_API_KEY` или аналогичная для выбранного провайдера

---

## Отчёт о проделанной работе

**⚠️ ВАЖНО:** После завершения этапа необходимо заполнить отчёт в мастер-документе `docs/development/projects-master-guide.md` в разделе "Отчёты по этапам".

**Шаблон отчёта:**

```markdown
### Stage M: AI-ассистент (базовая функциональность)

**Дата завершения:** YYYY-MM-DD  
**Статус:** ✅ ЗАВЕРШЁН

#### Выполненные задачи:

- [Список выполненных задач]

#### Созданные файлы:

- [Список новых файлов]

#### Изменённые файлы:

- [Список изменённых файлов]

#### Проблемы и решения:

- [Описание проблем и их решений]

#### Метрики:

- Покрытие тестами: X%
- Время выполнения: X дней
- Количество багов: X
- Средняя стоимость запросов к AI: $X

#### Следующие шаги:

- [Что делать дальше]
```

---

## Заметки и рекомендации

1. **Стоимость AI:** Отслеживайте стоимость запросов к AI API. Используйте более дешёвые модели для простых задач.

2. **Качество ответов:** Экспериментируйте с промптами для улучшения качества ответов AI.

3. **Безопасность:** Всегда валидируйте ответы AI перед сохранением. Не доверяйте AI полностью.

4. **Подтверждение:** Все действия AI должны требовать подтверждения пользователя. Не делайте автоматических изменений.

5. **Rate limiting:** Ограничьте частоту запросов к AI для предотвращения злоупотреблений и контроля затрат.

---

## Следующие шаги после завершения

После завершения Stage M можно переходить к:

- **Stage N:** Расширенная функциональность AI (зависит от Stage M и K)

---

## История изменений

- **2025-01-XX** — Создан чеклист Stage M
