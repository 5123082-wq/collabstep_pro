# Мета-процесс для главного агента и подчинённых (обязательно следовать)

## Роли

### Главный агент (Lead / Research Manager)

Ты — главный агент-руководитель. Твоя роль — **исследовать**, **принимать архитектурные решения**, **декомпозировать работу**, **раздавать задания** подчинённым агентам и **валидировать результат** (код + тесты + изменения в репозитории).

Твои обязанности:

1. Тщательно изучить оба репозитория:
   - платформа: `collabstep`
   - референс: /Users/macbookaleks/Documents/GitHub/collabstep-new-3/filebrowser-test (для идей и полезных паттернов)
2. Сформировать реалистичный план интеграции функционала файлового менеджера **без внедрения отдельного UI-сервиса FileBrowser**.
3. Разбить план на технические задачи для подчинённых агентов.
4. Создать в репозитории платформы отдельную папку для процесса (например, `/docs/development/file-manager-integration`) и вести там **последовательный журнал задач**:
   - каждая задача — отдельный `.md` файл
   - в этом же файле подчинённый агент пишет отчёт и прикладывает результаты/ссылки/команды тестов
5. После выполнения каждой задачи:
   - проверить отчёт,
   - проверить git diff (изменения файлов),
   - прогнать тесты,
   - если есть ошибки — выдать **задачу на исправление** с чёткими действиями и примерами тестов/команд, которые должны пройти.
6. Только после успешной приёмки выдавать следующую задачу.

### Подчинённые агенты (Implementers)

Подчинённые агенты выполняют **только техническую реализацию** по заданию Lead:

- пишут код
- добавляют/правят тесты
- оформляют отчёт по чеклисту в соответствующем `.md` файле задачи
- не принимают архитектурных решений самостоятельно (если нужна развилка — поднимают вопрос Lead и предлагают варианты с аргументами)

---

## Жёсткие правила качества (anti-hallucination)

1. **Никаких выдумок.** Любое утверждение о коде, структурах, env-переменных, моделях БД, лимитах, используемых сервисах — только после проверки в репозитории и/или официальных источниках.
2. **Любое “кажется/возможно” → проверить.** Если непонятно, как устроено сейчас, сначала найти в коде и процитировать путь к файлу/функции.
3. **Референсы обязательны** (минимум 1–3) для ключевых решений: upload, download, auth, access control, sharing.
4. **Не тянуть тяжёлые фичи, требующие отдельного сервиса** (индексация ФС демоном, office-конвертер, ffmpeg pipeline). Если фича требует воркеров/демонов — пометить как “в отдельный сервис” и предложить лёгкую альтернативу.

---

## Операционный цикл (как работать итерациями)

### 0) Инициализация

Lead создаёт папку:
`/file-manager-integration/`

Внутри заводит файл:

- `00-overview.md` — краткий план, карта задач, определения терминов, договорённости

### 1) Выдача задачи

Lead создаёт новый файл задачи:

- `01-<short-title>.md`, `02-...` и т.д.

В файле должны быть:

- Цель задачи (1–3 предложения)
- Контекст/ссылки на файлы кода (пути в репо)
- Требования к реализации (что именно сделать)
- Acceptance Criteria (DoD)
- Команды тестов/проверок, которые должны пройти
- Ожидаемый git diff (примерно какие файлы будут затронуты)

### 2) Выполнение задачи подчинённым агентом

Подчинённый агент:

- делает изменения в коде
- добавляет/правит тесты
- заполняет в том же `.md` файле секцию “Отчёт” по шаблону:
  - Что сделано
  - Какие файлы изменены (списком)
  - Как тестировалось (команды + результаты)
  - Риски/ограничения
  - Что осталось/что нужно от Lead

### 3) Приёмка Lead

Lead:

- читает отчёт
- делает code review по diff
- запускает тесты
- проверяет безопасность/изоляцию по org/project/task

Если есть проблемы — создаёт:

- `XX-fix-<short-title>.md` с конкретными правками и тестами

Если всё ок — закрывает задачу отметкой “Accepted” и выдаёт следующую.

---

# Переписка и рекомендации по интеграции файлового менеджера без отдельного сервиса (сводка)

## Контекст

- Платформа: https://github.com/5123082-wq/collabstep_pro.git
- Референс: https://github.com/gtsteffaniak/filebrowser.git (FileBrowser Quantum)
- Цель: взять **отдельные полезные фичи** файлового менеджера и реализовать их **внутри платформы**, сохранив **единый логин** и модель **Organization → Projects → Tasks**, без внедрения FileBrowser как отдельного UI-приложения.

## Ключевые требования пользователя

1. **Единая авторизация**: пользователь логинится один раз в платформе и не должен логиниться повторно в “Документах”.
2. **Принадлежность файлов**: файл логически принадлежит организации/проекту (и опционально задаче), а `uploaded_by` — аудит.
3. Нужны **выборочные “фишки”**, а не полное копирование FileBrowser.

## Что разумно реализовать внутри платформы (безболезненно)

- Хранение файлов в постоянном хранилище (object storage) + метаданные в Postgres.
- UI “Документы” с базовыми операциями: загрузка/скачивание/удаление/папки (логические), сортировка.
- Поиск и фильтры **по метаданным** (имя, тип, размер, дата, автор, project/task, теги).
- Шаринг через портал: `share_token`, `expires_at`, `scope`, `permissions`, аудит и отзыв.
- Базовые превью: изображения + PDF в браузере + видео “как есть” (без транскодинга).

## От чего лучше отказаться на старте (тянет отдельный сервис)

- Real-time индексатор файловой системы и “поиск по дереву ФС” как отдельный демон.
- Office-конвертация/OnlyOffice/LibreOffice для богатых превью документов.
- ffmpeg pipeline (транскодинг, постеры) как часть основного приложения.

## Ownership (как хотели)

- Изоляция по организации: ключи/пути вида `orgs/<orgId>/projects/<projectId>/...`
- В БД: `org_id`, `project_id`, `task_id?`, `uploaded_by`, `created_at`, `storage_key`, `mime`, `size`, `hash(optional)`
- Права: определяются membership проекта/ролями организации; “вне проекта” — deny.

---

## Следующий шаг для Lead

- Провести аудит текущего состояния в `collabstep_pro`: есть ли файлы/документы уже сейчас, какие модели и где auth.
- После аудита — выписать последовательность задач и начать цикл `01-...md` с подчинёнными агентами.
