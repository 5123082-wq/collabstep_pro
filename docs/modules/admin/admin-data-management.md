# Админка — Управление данными

## Обзор

Система управления данными позволяет администраторам просматривать статистику по проектам и задачам, а также безопасно удалять данные из памяти системы.

## Возможности

### 1. Просмотр статистики

- **Общая статистика**: количество проектов, задач и пользователей с данными
- **Данные по пользователям**: детальная информация о проектах и задачах каждого пользователя
- **Детализация проектов**: просмотр списка проектов пользователя с количеством задач

### 2. Удаление данных

- **Удаление всех данных**: полная очистка всех проектов и задач
- **Удаление данных пользователя**: удаление только проектов и задач конкретного пользователя
- **Каскадное удаление**: автоматическое удаление связанных данных (задачи, бюджеты, уведомления и т.д.)

## Использование

### Через UI (Админ-панель)

1. Откройте админ-панель: `/app/admin`
2. Выберите раздел **"Управление данными"**
3. Просмотрите текущую статистику
4. Выберите действие:
   - Нажмите **"Удалить все данные"** для полной очистки
   - Нажмите кнопку корзины рядом с пользователем для удаления его данных
5. Подтвердите действие в диалоговом окне

### Через скрипт

Используйте скрипт `clear-all-data.ts` для удаления через API:

```bash

# Запустите сервер Next.js (если еще не запущен)

pnpm dev

# В другом терминале запустите скрипт

npx tsx scripts/clear-all-data.ts
```

Скрипт выполнит:

1. Получение текущей статистики
2. Удаление всех данных
3. Проверку результата

## API Endpoints

### GET /api/admin/data/stats

Получение статистики по проектам и задачам.

**Требования:**

- Авторизация: требуется
- Роль: `admin`

**Ответ:**

```json
{
  "summary": {
    "totalProjects": 2,
    "totalTasks": 10,
    "totalUsers": 2
  },
  "users": [
    {
      "userId": "admin.demo@collabverse.test",
      "userName": "Алина Админ",
      "userEmail": "admin.demo@collabverse.test",
      "projectsCount": 1,
      "tasksCount": 5,
      "projects": [
        {
          "id": "project-id",
          "key": "PROJ",
          "title": "Название проекта",
          "status": "active",
          "tasksCount": 5,
          "createdAt": "2025-11-16T..."
        }
      ]
    }
  ]
}
```

### POST /api/admin/data/clear

Удаление проектов и задач из памяти.

**Требования:**

- Авторизация: требуется
- Роль: `admin`

**Тело запроса:**

```json
{
  "confirm": true,
  "userId": "user-id" // опционально, для удаления данных конкретного пользователя
}
```

**Ответ:**

```json
{
  "success": true,
  "deleted": {
    "projects": 2,
    "tasks": 10
  },
  "before": {
    "projects": 2,
    "tasks": 10
  },
  "after": {
    "projects": 0,
    "tasks": 0
  },
  "scope": "all" // или "user:user-id"
}
```

## Безопасность

1. **Требуется подтверждение**: все операции удаления требуют явного подтверждения
2. **Только для администраторов**: доступ к функциям имеют только пользователи с ролью `admin`
3. **Аудит действий**: все операции логируются для отслеживания
4. **Двойное подтверждение в UI**: диалоговое окно с предупреждением перед удалением

## Что удаляется

При удалении проектов автоматически удаляются:

- ✅ Все задачи проекта
- ✅ Зависимости задач
- ✅ Участники проекта
- ✅ Расходы и их вложения
- ✅ Бюджеты проекта
- ✅ Уведомления, связанные с задачами и проектами
- ✅ Сообщения чата проекта

## Структура файлов

```text
apps/web/
  app/
    api/
      admin/
        data/
          stats/
            route.ts       # API для получения статистики
          clear/
            route.ts       # API для удаления данных
    (app)/
      app/
        admin/
          data/
            page.tsx       # UI страница управления данными
          page.tsx         # Главная страница админки (добавлена карточка)

scripts/
  clear-all-data.ts        # Скрипт для удаления через API

docs/
  admin/
    data-management.md     # Эта документация
```

## Примеры использования

### Пример 1: Очистка всех данных

```typescript
const response = await fetch('/api/admin/data/clear', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ confirm: true }),
});

const result = await response.json();
console.log(
  `Удалено: ${result.deleted.projects} проектов, ${result.deleted.tasks} задач`
);
```

### Пример 2: Удаление данных пользователя

```typescript
const response = await fetch('/api/admin/data/clear', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    confirm: true,
    userId: 'user.demo@collabverse.test',
  }),
});
```

### Пример 3: Получение статистики

```typescript
const response = await fetch('/api/admin/data/stats');
const stats = await response.json();

console.log(`Всего проектов: ${stats.summary.totalProjects}`);
console.log(`Всего задач: ${stats.summary.totalTasks}`);
```

## Устранение неполадок

### Ошибка: "Сервер недоступен"

**Решение:** Убедитесь, что сервер Next.js запущен:

```bash
pnpm dev
```

### Ошибка: "unauthorized" (401)

**Решение:** Авторизуйтесь как администратор в браузере перед использованием API.

### Ошибка: "forbidden" (403)

**Решение:** Убедитесь, что у вашей учетной записи есть роль `admin`.

### Данные не удаляются

**Проверьте:**

1. Сервер запущен и работает
2. В консоли браузера нет ошибок
3. API endpoints отвечают корректно
4. Используется правильная сессия администратора

## Дополнительные ресурсы

- [Админ-панель README](https://github.com/5123082-wq/collabstep_pro/blob/main/apps/web/app/%28app%29/admin/README.md)
- [Системный анализ (API обзор)](../architecture/system-analysis.md)