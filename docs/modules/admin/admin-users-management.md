# Админка — Управление пользователями

**Статус:** active  
**Владелец:** product/engineering  
**Создан:** 2026-01-07  
**Последнее обновление:** 2026-01-07

Документация по управлению пользователями через админ-панель.

## Назначение

Администраторы могут управлять пользователями платформы: просматривать список, редактировать статусы и роли, блокировать и удалять пользователей.

## Доступные функции

### 1. Просмотр списка пользователей

- **Страница**: `/admin/users`
- **Функции**:
  - Поиск по email или имени
  - Фильтрация по статусу (все, активные, заблокированные, приглашённые)
  - Отображение ролей пользователя
  - Индикация AI-агентов
  - Индикация сиротских записей (пользователи без соответствующей записи в workspace)

### 2. Редактирование пользователя

#### Статус пользователя

Можно изменить статус пользователя:
- **Активен** — пользователь имеет полный доступ к платформе
- **Заблокирован** — пользователь временно заблокирован
- **Приглашён** — пользователь приглашён, но ещё не активировал аккаунт

#### Роли платформы

Администратор может назначать пользователю одну или несколько ролей:

- **`productAdmin`** — Администратор продукта
  - Доступ к админ-панели
  - Управление feature flags
  - Полный доступ к системным функциям

- **`featureAdmin`** — Администратор фич
  - Управление feature flags
  - Настройка доступности модулей

- **`supportAgent`** — Агент поддержки
  - Доступ к модулю поддержки
  - Управление тикетами поддержки

- **`financeAdmin`** — Администратор финансов
  - Доступ к финансовому модулю
  - Управление бюджетами и расходами

- **`betaTester`** — Бета-тестер
  - Доступ к бета-фичам
  - Тестирование новых функций

- **`viewer`** — Наблюдатель
  - Базовый просмотр
  - Ограниченный доступ

**Важно**: Роли назначаются через чекбоксы в модальном окне редактирования. Можно выбрать несколько ролей одновременно.

### 3. Блокировка и активация пользователей

- Быстрое блокирование через кнопку в таблице
- Быстрая активация заблокированных пользователей
- Изменение статуса также доступно через модальное окно редактирования

### 4. Удаление пользователей

- Удаление пользователя из системы
- **Ограничение**: нельзя удалить самого себя
- **Ограничение**: нельзя удалить AI-агентов
- Требуется подтверждение перед удалением

## Использование

### Редактирование ролей пользователя

1. Откройте страницу `/admin/users`
2. Найдите нужного пользователя через поиск или фильтры
3. Нажмите кнопку редактирования (иконка карандаша) рядом с пользователем
4. В модальном окне:
   - Измените статус при необходимости
   - Выберите роли, установив соответствующие чекбоксы
   - Нажмите "Сохранить"
5. Изменения применяются немедленно

### Блокировка пользователя

1. Найдите пользователя в списке
2. Нажмите кнопку блокировки (иконка с крестиком)
3. Пользователь будет заблокирован немедленно

### Активация пользователя

1. Найдите заблокированного пользователя
2. Нажмите кнопку активации (иконка с галочкой)
3. Пользователь будет активирован немедленно

## API Endpoints

### GET /api/admin/users

Получение списка всех пользователей.

**Требования:**
- Авторизация: требуется
- Роль: `admin` (в демо-режиме)

**Ответ:**
```json
{
  "items": [
    {
      "userId": "00000000-0000-0000-0000-000000000001",
      "name": "Алина Админ",
      "email": "admin.demo@collabverse.test",
      "status": "active",
      "roles": ["productAdmin", "featureAdmin"],
      "testerAccess": [],
      "updatedAt": "2026-01-07T00:00:00.000Z",
      "updatedBy": "00000000-0000-0000-0000-000000000001"
    }
  ]
}
```

### GET /api/admin/users/[id]

Получение детальной информации о пользователе.

**Требования:**
- Авторизация: требуется
- Роль: `admin`

**Ответ:**
```json
{
  "item": {
    "userId": "00000000-0000-0000-0000-000000000001",
    "name": "Алина Админ",
    "email": "admin.demo@collabverse.test",
    "status": "active",
    "roles": ["productAdmin", "featureAdmin"],
    "testerAccess": [],
    "updatedAt": "2026-01-07T00:00:00.000Z",
    "updatedBy": "00000000-0000-0000-0000-000000000001"
  }
}
```

### PATCH /api/admin/users/[id]

Обновление пользователя (статус, роли, testerAccess, notes).

**Требования:**
- Авторизация: требуется
- Роль: `admin`

**Тело запроса:**
```json
{
  "status": "active",  // опционально: "active" | "suspended" | "invited"
  "roles": ["productAdmin", "featureAdmin"],  // опционально: массив ролей
  "testerAccess": [],  // опционально: массив ID модулей
  "notes": "Заметка о пользователе"  // опционально: строка до 500 символов
}
```

**Ответ:**
```json
{
  "item": {
    "userId": "00000000-0000-0000-0000-000000000001",
    "name": "Алина Админ",
    "email": "admin.demo@collabverse.test",
    "status": "active",
    "roles": ["productAdmin", "featureAdmin"],
    "testerAccess": [],
    "updatedAt": "2026-01-07T00:00:00.000Z",
    "updatedBy": "00000000-0000-0000-0000-000000000001"
  }
}
```

### DELETE /api/admin/users/[id]

Удаление пользователя из системы.

**Требования:**
- Авторизация: требуется
- Роль: `admin`

**Ограничения:**
- Нельзя удалить самого себя
- Нельзя удалить AI-агентов

**Ответ:**
```json
{
  "success": true
}
```

## Безопасность

1. **Требуется авторизация**: все операции требуют активной сессии администратора
2. **Проверка прав**: доступ к админ-панели ограничен ролями `ADMIN` или `MODERATOR`
3. **Защита от самоудаления**: нельзя удалить самого себя
4. **Защита AI-агентов**: AI-агенты не могут быть удалены через UI
5. **Валидация данных**: все данные валидируются на сервере перед применением

## Особенности реализации

### Сиротские записи

Если пользователь существует в системе управления (`userControl`), но отсутствует в таблице пользователей (`user`), он отображается как "сиротская запись" с предупреждением. Такие записи можно редактировать, но рекомендуется проверить целостность данных.

### AI-агенты

AI-агенты автоматически определяются по:
- Флагу `isAI` в данных пользователя
- Email с доменом `@collabverse.ai`

AI-агенты имеют специальную визуальную индикацию и не могут быть удалены через UI.

### Обновление данных

- Данные обновляются в реальном времени
- При сохранении изменений показывается индикатор загрузки
- После успешного сохранения список пользователей автоматически обновляется

## Структура файлов

```text
apps/web/
  app/
    (app)/
      admin/
        users/
          page.tsx          # UI страница управления пользователями
    api/
      admin/
        users/
          route.ts          # API: список пользователей
          [id]/
            route.ts        # API: детали, обновление, удаление пользователя

apps/api/src/
  services/
    admin-service.ts        # Сервис управления пользователями
  repositories/
    admin-user-controls-repository.ts  # Репозиторий для работы с ролями
```

## Примеры использования

### Пример 1: Назначение роли администратора продукта

```typescript
const response = await fetch('/api/admin/users/[USER_ID]', {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    roles: ['productAdmin', 'featureAdmin']
  })
});
```

### Пример 2: Блокировка пользователя

```typescript
const response = await fetch('/api/admin/users/[USER_ID]', {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    status: 'suspended'
  })
});
```

### Пример 3: Получение списка пользователей

```typescript
const response = await fetch('/api/admin/users');
const data = await response.json();
console.log(`Всего пользователей: ${data.items.length}`);
```

## Устранение неполадок

### Ошибка: "unauthorized" (401)

**Решение:** Авторизуйтесь как администратор в браузере перед использованием админ-панели.

### Ошибка: "forbidden" (403)

**Решение:** Убедитесь, что у вашей учетной записи есть роль `admin` в демо-режиме или соответствующие системные роли (`productAdmin` или `featureAdmin`).

### Роли не сохраняются

**Проверьте:**
1. У вас есть права администратора
2. В консоли браузера нет ошибок
3. API endpoint отвечает корректно
4. Роли указаны в правильном формате (массив строк)

### Пользователь не отображается в списке

**Возможные причины:**
1. Пользователь не существует в системе управления
2. Фильтры скрывают пользователя
3. Поисковый запрос не соответствует данным пользователя

---

**Связанные документы:**
- [Обзор админ-панели](./admin-overview.md)
- [Роли и права доступа](../../platform/roles-permissions.md)
- [Управление данными](./admin-data-management.md)
