# Проекты и задачи — Файлы

**Статус:** stable  
**Владелец:** product  
**Создан:** 2026-01-06  
**Последнее обновление:** 2026-01-06

## Введение

Файловый менеджер проекта обеспечивает централизованное управление файлами: загрузку, организацию в папки, публичные ссылки для доступа, корзину для восстановления. Файлы могут быть привязаны к проектам, задачам, комментариям, документам и сообщениям чата. Хранилище — Vercel Blob Storage с метаданными в PostgreSQL.

**Статус реализации:** ✅ Завершён

## Структура файла

### Поля файла

```typescript
interface FileObject {
  id: ID;
  uploaderId: ID; // Пользователь, загрузивший файл
  filename: string;
  mimeType: string;
  sizeBytes: number;
  storageUrl: string; // URL в Vercel Blob Storage
  sha256?: string; // SHA256 хэш файла
  description?: string;
  uploadedAt: string;
}
```

### Привязка файлов к сущностям

Файлы могут быть привязаны к различным сущностям через таблицу `attachments`:

```typescript
interface Attachment {
  id: ID;
  fileId: ID;
  linkedEntity: AttachmentEntityType; // 'project' | 'task' | 'comment' | 'document' | 'project_chat'
  entityId: ID | null;
  createdAt: string;
  createdBy: ID;
}
```

**Типы сущностей:**
- **`project`** — файл привязан к проекту
- **`task`** — файл привязан к задаче
- **`comment`** — файл привязан к комментарию
- **`document`** — файл привязан к документу
- **`project_chat`** — файл привязан к сообщению в чате проекта

## Загрузка и скачивание файлов

### Загрузка файла

**API endpoint:**
- `POST /api/files`

**Формат запроса:**
- `multipart/form-data` с полем `file`
- Опциональные поля: `projectId`, `entityType`, `entityId`

**Обязательные требования:**
- Пользователь должен быть авторизован
- Проект должен существовать и иметь `organizationId` (не null)
- Пользователь должен иметь доступ к проекту (роль не 'viewer')

**Процесс загрузки:**
1. Валидация файла (размер, тип)
2. Проверка лимитов организации (размер файла, общий объем хранилища)
3. Вычисление SHA256 хэша файла
4. Загрузка в Vercel Blob Storage
5. Сохранение метаданных в БД
6. Создание записи в таблице `attachments` (если указаны `entityType` и `entityId`)
7. Обновление счетчика использования хранилища организации

**Лимиты хранилища:**
- **Free план:** ограниченный объем хранилища
- **Pro план:** увеличенный объем хранилища
- **Max план:** неограниченный объем хранилища

### Скачивание файла

**API endpoint:**
- `GET /api/files/[id]` — скачать файл через серверный прокси

**Процесс скачивания:**
1. Проверка прав доступа к файлу
2. Получение файла из Vercel Blob Storage
3. Проксирование файла через сервер (безопасность)

**Права доступа:**
- Участники проекта могут скачивать файлы проекта
- Публичные ссылки позволяют скачивать файлы без авторизации (если настроено)

## Хранилище

### Vercel Blob Storage

Файлы хранятся в Vercel Blob Storage:
- **Преимущества:** масштабируемость, CDN, безопасность
- **Интеграция:** через `@vercel/blob` пакет
- **Изоляция:** файлы изолированы по организациям (`orgs/<orgId>/projects/<projectId>/...`)

**См. также:**
- `CONTINUITY.md` — информация о реализации файлового менеджера

### Метаданные в БД

Метаданные файлов хранятся в PostgreSQL:
- Таблица `files` — основная информация о файлах
- Таблица `attachments` — привязка файлов к сущностям
- Таблица `file_trash` — корзина для удаленных файлов

## Папки

### Системные папки

- **Results** — результаты работы (системная папка)
- **Attachments** — вложения (системная папка)

### Кастомные папки

Пользователи могут создавать собственные папки для организации файлов:
- Создание папок через UI
- Перемещение файлов между папками
- Удаление папок (файлы перемещаются в корзину)

**API endpoint:**
- `GET /api/pm/projects/[id]/folders` — получить список папок проекта
- `POST /api/pm/projects/[id]/folders` — создать папку
- `DELETE /api/pm/projects/[id]/folders/[folderId]` — удалить папку

**При удалении папки:**
- Все файлы папки перемещаются в корзину
- Владельцы проектов получают уведомление (логируется для будущей системы уведомлений)

## Привязка файлов

### К задачам

Файлы могут быть прикреплены к задачам:
- При создании/редактировании задачи
- Через поле `attachments` в задаче
- Отображаются в детальном виде задачи

### К комментариям

Файлы могут быть прикреплены к комментариям:
- При создании/редактировании комментария
- Через поле `attachments` в комментарии
- Отображаются в комментарии

**См. также:**
- [`comments.md`](./projects-tasks-comments.md) — документация по комментариям

### К документам

Файлы могут быть привязаны к документам проекта:
- При создании/редактировании документа
- Поддержка версионности документов

### К чату проекта

Файлы могут быть прикреплены к сообщениям в чате:
- При отправке сообщения в чате
- Отображаются в сообщении

**См. также:**
- [`chat.md`](./projects-tasks-chat.md) — документация по чату

### К проекту

Файлы могут быть загружены напрямую в проект:
- Через вкладку "Файлы" на странице проекта
- Отображаются в файловом каталоге проекта

**См. также:**
- [`projects.md`](./projects-tasks-projects.md) — документация по проектам

## Публичные ссылки

### Share links

**Статус:** ⚠️ Планируется

В будущем планируется добавить публичные ссылки для доступа к файлам:
- Генерация токена доступа (`share_token`)
- Настройка срока действия (`expires_at`)
- Настройка области доступа (`scope`)
- Настройка прав (`permissions`: view, download)
- Аудит доступа и отзыв ссылок

**Безопасность:**
- Публичный просмотр через share link
- Скачивание требует авторизации через серверный прокси (безопасность)

## Корзина

### Удаление файлов

**API endpoint:**
- `DELETE /api/files/[id]` — удалить файл

**Процесс удаления:**
1. Файл перемещается в корзину (таблица `file_trash`)
2. Метаданные сохраняются для восстановления
3. Файл в хранилище не удаляется сразу

### Восстановление файлов

**API endpoint:**
- `POST /api/files/[id]/restore` — восстановить файл из корзины

**Процесс восстановления:**
1. Файл перемещается обратно из корзины
2. Восстанавливаются привязки к сущностям
3. Файл снова доступен в проекте

### Автоматическая очистка корзины

**Лимиты хранения в корзине:**
- **Free план:** 7 дней
- **Pro план:** 30 дней
- **Max план:** неограниченно

После истечения срока файлы удаляются безвозвратно.

## Лимиты хранилища

### Планы подписки

- **Free:** ограниченный объем хранилища
- **Pro:** увеличенный объем хранилища
- **Max:** неограниченный объем хранилища

### Проверка лимитов

При загрузке файла:
- Проверяется размер файла
- Проверяется общий объем хранилища организации
- Если лимит превышен, возвращается ошибка

**API endpoint:**
- `GET /api/organizations/[id]/storage-usage` — получить использование хранилища

## Предпросмотр файлов

### Поддерживаемые типы

- **Изображения:** JPEG, PNG, GIF, WebP — предпросмотр в браузере
- **PDF:** предпросмотр в браузере
- **Видео:** воспроизведение "как есть" (без транскодинга)

### Неподдерживаемые типы

- **Office документы:** требуется конвертация (планируется интеграция с OnlyOffice/LibreOffice)
- **Аудио:** воспроизведение "как есть"
- **Другие:** скачивание без предпросмотра

## API endpoints

### Основные операции

- `POST /api/files` — загрузить файл
- `GET /api/files/[id]` — скачать файл
- `DELETE /api/files/[id]` — удалить файл

### Восстановление

- `POST /api/files/[id]/restore` — восстановить файл из корзины

### Папки проекта

- `GET /api/pm/projects/[id]/folders` — получить список папок
- `POST /api/pm/projects/[id]/folders` — создать папку
- `DELETE /api/pm/projects/[id]/folders/[folderId]` — удалить папку

### Файлы проекта

- `GET /api/pm/projects/[id]/files` — получить список файлов проекта
- `POST /api/pm/projects/[id]/files` — загрузить файл в проект

## Связанные документы

- [`_module.md`](./projects-tasks-overview.md) — обзор модуля PM Core
- [`projects.md`](./projects-tasks-projects.md) — файлы в проектах
- [`tasks.md`](./projects-tasks-tasks.md) — файлы в задачах
- [`comments.md`](./projects-tasks-comments.md) — файлы в комментариях
- [`chat.md`](./projects-tasks-chat.md) — файлы в чате
- [`../../archive/2026-01-07-pm-core-migration/file-manager-integration/`](../../archive/2026-01-07-pm-core-migration/file-manager-integration/) — документация по интеграции файлового менеджера (архив)
- `CONTINUITY.md` — информация о реализации файлового менеджера

---

**Последнее обновление:** 2026-01-06
