# Проекты и задачи — Доступ

**Статус:** stable  
**Владелец:** product  
**Создан:** 2026-01-06  
**Последнее обновление:** 2026-01-06

## Введение

Модель доступа к проектам определяет роли участников, права доступа для каждой роли, проверку прав и процесс приглашения участников. Доступ контролируется на уровне проекта и организации.

**Статус реализации:** ✅ Завершён

## Роли в проекте

### Типы ролей

Роли определяются в `project_role` enum в базе данных:

- **`owner`** — владелец проекта. Полный контроль над проектом
- **`manager`** — менеджер проекта. Может управлять задачами, командой, но не удалять проект
- **`contributor`** — участник проекта. Может создавать и редактировать задачи, комментировать
- **`viewer`** — наблюдатель. Только просмотр задач и комментариев

**Примечание:** Создатель проекта автоматически получает роль `owner`.

## Матрица прав доступа

### Проект

| Действие | Owner | Manager | Contributor | Viewer |
|----------|:-----:|:-------:|:-----------:|:-----:|
| Создать проект | ✅ | ✅ | ✅ | ❌ |
| Удалить проект | ✅ | ❌ | ❌ | ❌ |
| Архивировать проект | ✅ | ✅ | ❌ | ❌ |
| Пригласить участника в проект | ✅ | ✅ | ❌ | ❌ |
| Удалить участника из проекта | ✅ | ✅ | ❌ | ❌ |
| Изменить роль участника | ✅ | ✅ | ❌ | ❌ |
| Создать задачу | ✅ | ✅ | ✅ | ❌ |
| Редактировать задачу | ✅ | ✅ | ✅ | ❌ |
| Удалить задачу | ✅ | ✅ | ❌ | ❌ |
| Изменить статус задачи | ✅ | ✅ | ✅ | ❌ |
| Комментировать задачу | ✅ | ✅ | ✅ | ❌ |
| Просмотр проекта | ✅ | ✅ | ✅ | ✅ |
| Просмотр задач | ✅ | ✅ | ✅ | ✅ |
| Публикация в маркетплейс | ✅ | ✅ | ✅ | ❌ |
| Управление бюджетом | ✅ | ✅ | ❌ | ❌ |
| Создание расходов | ✅ | ✅ | ✅ | ❌ |
| Утверждение расходов | ✅ | ✅ | ❌ | ❌ |

**См. также:**
- [`../../platform/roles-permissions.md`](../../platform/roles-permissions.md) — детальная матрица прав

## Проверка прав

### Backend

**Функция проверки доступа:**
```typescript
// Проверка роли в проекте
const projectMember = await projectsRepository.getMember(projectId, userId);
if (!projectMember || projectMember.role === 'viewer') {
  throw new Error('Forbidden');
}

// Проверка конкретного права
const hasAccess = await projectsRepository.hasAccess(projectId, userId, 'edit');
if (!hasAccess) {
  throw new Error('Forbidden');
}
```

**Расположение:**
- `apps/api/src/repositories/projects-repository.ts` — методы `getMember()`, `hasAccess()`

### Frontend

**Проверка роли:**
```typescript
import { getUserRoles } from '@/lib/auth/roles';
const roles = getUserRoles();
if (roles.includes('ADMIN')) {
  // Показать админ-панель
}
```

**Проверка доступа к проекту:**
```typescript
import { canAccessProject } from '@/lib/auth/roles';
if (canAccessProject(projectId, 'edit')) {
  // Показать кнопку редактирования
}
```

## Приглашения в проект

### Процесс приглашения

**Двухэтапный процесс:**

1. **Создание приглашения**
   - Владелец/менеджер создает приглашение
   - Генерируется токен доступа
   - Приглашение отправляется по ссылке или email

2. **Принятие приглашения**
   - Пользователь переходит по ссылке с токеном
   - Просматривает предпросмотр проекта
   - Принимает приглашение (статус: `pending_owner_approval`)

3. **Одобрение владельцем**
   - Владелец проекта видит заявку на вступление
   - Одобряет или отклоняет приглашение
   - При одобрении создается запись `ProjectMember`

### API endpoints

- `GET /api/pm/projects/[id]/invites` — получить список приглашений
- `POST /api/pm/projects/[id]/invites` — создать приглашение
- `GET /api/projects/invites/[token]` — предпросмотр проекта по токену
- `POST /api/projects/invites/[token]/accept` — принять приглашение
- `POST /api/projects/[projectId]/invites/[inviteId]/approve` — одобрить приглашение
- `POST /api/projects/[projectId]/invites/[inviteId]/reject` — отклонить приглашение

### Способы приглашения

**По ссылке:**
- Генерация пригласительной ссылки с токеном
- Настройка TTL (время жизни ссылки)
- Настройка лимита использований

**По email:**
- Отправка приглашения на email
- Если пользователь не зарегистрирован → письмо с ссылкой на регистрацию
- Если пользователь зарегистрирован → уведомление в системе

## Внешние участники

### Contractors

Участники из других организаций могут быть приглашены в проект:
- Их права определяются ролью в проекте, а не ролью в организации
- Они имеют доступ только к проекту, к которому приглашены
- Они не имеют доступа к другим проектам организации

### Guests

Временные участники с ограниченными правами:
- Только просмотр (роль `viewer`)
- Не могут создавать или редактировать задачи
- Доступ только к конкретному проекту

## Особые случаи

### Мультиаккаунт

- Пользователь может состоять в нескольких организациях с разными ролями
- Активная организация определяется через `OrganizationContext`
- Права применяются в контексте активной организации

### Общие проекты

- Проект может быть видимым для workspace (`workspace` visibility)
- Участники workspace могут просматривать общие проекты
- Для редактирования требуется явное приглашение в проект

### Публичные проекты

- Проект с `public` visibility виден всем авторизованным пользователям
- Только участники проекта могут редактировать
- Публичный просмотр не требует приглашения

## Интеграция с системой аутентификации

### Dev-режим

В dev-режиме (`AUTH_DEV=on`) используется cookie `cv_session`:
```json
{
  "email": "user@example.com",
  "role": "admin",
  "issuedAt": "2026-01-06T00:00:00.000Z"
}
```

### Production (планируется)

- JWT/паспортный токен, подписанный server-side ключом
- Refresh-токены в Redis/БД для отзыва сессий
- Payload расширен до `{ userId, activeAccountId, roles, issuedAt }`

## Связанные документы

- [`_module.md`](./projects-tasks-overview.md) — обзор модуля PM Core
- [`projects.md`](./projects-tasks-projects.md) — команда проекта
- [`teams.md`](./projects-tasks-teams.md) — команды проектов
- [`../../platform/roles-permissions.md`](../../platform/roles-permissions.md) — детальная матрица прав
- [`../../archive/2026-01-07-pm-core-migration/projects-access-model/`](../../archive/2026-01-07-pm-core-migration/projects-access-model/) — документация по модели доступа (архив)

---

**Последнее обновление:** 2026-01-06