# Проекты и задачи — Задачи

**Статус:** stable  
**Владелец:** product  
**Создан:** 2026-01-06  
**Последнее обновление:** 2026-01-06

## Введение

Задача — основная единица работы в проекте. Задачи поддерживают иерархию (родитель-ребенок), статусы из workflow проекта, метки, назначения, зависимости, комментарии и файлы. Задачи могут отображаться в различных представлениях: Kanban, List, Calendar, Gantt.

## Структура задачи

### Поля задачи

```typescript
interface Task {
  id: ID;
  projectId: ID;
  number: number; // Автоинкремент по проекту (например, PROJ-123)
  parentId: ID | null;
  title: string;
  description?: string;
  status: TaskStatus; // Статус из workflow проекта
  iterationId?: ID;
  assigneeId?: ID;
  startAt?: string; // Дата начала
  startDate?: string; // Алиас для startAt
  dueAt?: string; // Срок выполнения
  priority?: 'low' | 'med' | 'high' | 'urgent';
  labels?: string[];
  attachments?: FileObject[];
  estimatedTime?: number | null; // В часах
  storyPoints?: number | null; // Story points оценка
  loggedTime?: number | null; // В минутах
  price?: string | null; // Бюджет задачи
  currency?: string | null; // Валюта (например, 'RUB')
  createdAt: string;
  updatedAt: string;
}
```

### Статусы задач

Статусы задач определяются workflow проекта. Типичные статусы:

- `new` — новая задача
- `in_progress` — в работе
- `review` — на проверке
- `done` — выполнена
- `cancelled` — отменена

**Примечание:** Статусы могут быть настроены для каждого проекта через workflow.

### Приоритеты

- **`low`** — низкий приоритет
- **`med`** — средний приоритет
- **`high`** — высокий приоритет
- **`urgent`** — срочный приоритет

## Создание и управление задачами

### Создание задачи

**API endpoint:**

- `POST /api/pm/tasks`

**Обязательные поля:**

- `projectId` (string) — ID проекта
- `title` (string) — название задачи
- `status` (TaskStatus) — статус задачи

**Опциональные поля:**

- `assigneeId` (string) — ID назначенного пользователя
- `priority` (string) — приоритет
- `startDate` / `startAt` (string) — дата начала
- `dueAt` (string) — срок выполнения
- `labels` (string[]) — метки
- `description` (string) — описание
- `estimatedTime` (number) — оценка времени в часах
- `storyPoints` (number) — story points
- `parentId` (string | null) — ID родительской задачи

**Права доступа:**

- `owner` — может создавать задачи
- `manager` — может создавать задачи
- `contributor` — может создавать задачи
- `viewer` — не может создавать задачи

**Автоматические действия:**

- При назначении задачи (`assigneeId`) генерируется уведомление
- Если назначен AI-агент, обрабатывается назначение агента

### Обновление задачи

**API endpoint:**

- `PATCH /api/pm/tasks/[id]` — обновить одну задачу
- `POST /api/pm/tasks/bulk` — массовое обновление задач

**Доступные поля для обновления:**

- `title` — название
- `description` — описание
- `status` — статус
- `assigneeId` — назначенный пользователь
- `priority` — приоритет
- `startAt` / `startDate` — дата начала
- `dueAt` — срок выполнения
- `labels` — метки
- `estimatedTime` — оценка времени
- `storyPoints` — story points
- `parentId` — родительская задача

**Права доступа:**

- `owner` — может обновлять все поля
- `manager` — может обновлять все поля
- `contributor` — может обновлять свои задачи
- `viewer` — не может обновлять задачи

### Удаление задачи

**API endpoint:**

- `DELETE /api/pm/tasks/[id]`

**Действия:**

- Задача удаляется из базы данных
- Все дочерние задачи также удаляются (каскадное удаление)
- Все комментарии и файлы задачи удаляются

**Права доступа:**

- `owner` — может удалять задачи
- `manager` — может удалять задачи
- `contributor` — не может удалять задачи
- `viewer` — не может удалять задачи

## Иерархия задач

Задачи поддерживают иерархическую структуру через поле `parentId`.

### Родительские и дочерние задачи

- **Родительская задача** (`parentId = null`) — верхний уровень иерархии
- **Дочерняя задача** (`parentId != null`) — подзадача родительской задачи

### Создание подзадачи

1. При создании задачи указать `parentId` родительской задачи
2. Подзадача автоматически наследует проект от родителя
3. Подзадача может иметь свой статус, приоритет, назначение

### Отображение иерархии

- В Kanban доске задачи отображаются с отступом для подзадач
- В List представлении задачи группируются по родителям
- В Gantt диаграмме задачи отображаются в иерархической структуре

## Статусы и workflow

### Workflow проекта

Workflow определяет набор статусов для проекта и возможные переходы между ними.

**Структура workflow:**

- Набор статусов (например, `new`, `in_progress`, `review`, `done`)
- Возможные переходы между статусами
- Начальный статус для новых задач

**Использование:**

- Workflow определяет колонки Kanban доски
- Workflow определяет доступные статусы при создании/обновлении задачи
- Workflow может быть настроен для каждого проекта

### Переходы между статусами

Переходы между статусами могут быть ограничены workflow:

- Некоторые переходы могут быть запрещены
- Некоторые переходы могут требовать подтверждения
- Некоторые переходы могут автоматически генерировать уведомления

## Назначение задач

### Назначение исполнителя

**Поля:**

- `assigneeId` (ID) — ID назначенного пользователя

**Действия при назначении:**

- Генерируется уведомление для назначенного пользователя
- Если назначен AI-агент, обрабатывается назначение агента
- Задача появляется в списке задач назначенного пользователя

### Назначение ревьюера

**Планируется:**

- Поле `reviewerId` для назначения ревьюера
- Уведомления для ревьюера при изменении статуса на `review`

### Массовое назначение

**API endpoint:**

- `POST /api/pm/tasks/bulk` — массовое обновление задач

**Пример:**

```json
{
  "taskIds": ["task-1", "task-2", "task-3"],
  "assigneeId": "user-123"
}
```

## Метки и категории

### Метки задач

**Поле:**

- `labels` (string[]) — массив меток

**Использование:**

- Метки используются для категоризации задач
- Метки отображаются на карточках задач в Kanban
- Метки используются для фильтрации задач

### Создание меток

Метки создаются автоматически при указании в задаче или могут быть предопределены в проекте.

## Зависимости задач

### Типы зависимостей

**Структура:**

```typescript
interface TaskDependency {
  id: ID;
  dependentTaskId: ID; // Задача, которая блокируется
  blockerTaskId: ID; // Задача, которая блокирует
  type: 'blocks' | 'relates_to';
  createdAt: string;
}
```

**Типы:**

- **`blocks`** — задача блокирует другую задачу (нельзя начать, пока не завершена блокирующая)
- **`relates_to`** — задачи связаны (информационная связь)

### API endpoints

- `GET /api/pm/tasks/[id]/dependencies` — получить зависимости задачи
- `POST /api/pm/tasks/[id]/dependencies` — создать зависимость
- `DELETE /api/pm/tasks/[id]/dependencies/[depId]` — удалить зависимость

### Валидация циклических зависимостей

При создании зависимости проверяется наличие циклов:

- Если зависимость создаёт цикл, возвращается ошибка
- Валидация выполняется через `dependency-validator.ts`

**См. также:**

- [`kanban.md`](./projects-tasks-kanban.md) — Kanban представление
- [`_implementation-plan.md`](./projects-tasks-implementation-plan.md#stage-k) — Stage K: Диаграмма Ганта

## Представления задач

### Kanban

Kanban доска отображает задачи в виде колонок по статусам.

**Функции:**

- Drag & drop между колонками (изменение статуса)
- Группировки: по assignee, priority, срокам
- Фильтры и сортировки
- Массовые операции

**См. также:**

- [`kanban.md`](./projects-tasks-kanban.md) — детальная документация по Kanban

### List

Табличное представление задач (Excel-подобное).

**Функции:**

- Настраиваемые колонки
- Инлайн-редактирование
- Фильтры и сортировки на уровне колонок
- Пресеты представлений
- Экспорт в CSV

**API endpoint:**

- `GET /api/pm/tasks?view=list` — получить задачи для List представления

### Calendar

Календарное представление задач.

**Функции:**

- Переключение: День/Неделя/Месяц
- Drag-to-reschedule (изменение сроков перетаскиванием)
- Переключатель "Только мои/Все" задачи
- Отображение задач по датам начала и окончания

**API endpoint:**

- `GET /api/pm/tasks?view=calendar&startDate=...&endDate=...` — получить задачи для календаря

### Gantt

Диаграмма Ганта для визуализации задач по срокам.

**Функции:**

- Отображение задач на временной шкале
- Перетаскивание для изменения сроков
- Отображение зависимостей стрелками
- Вычисление и отображение критического пути
- Масштабирование: день/неделя/месяц
- Фильтрация по статусу и исполнителю

**См. также:**

- [`_implementation-plan.md`](./projects-tasks-implementation-plan.md#stage-k) — Stage K: Диаграмма Ганта

**API endpoint:**

- `GET /api/pm/projects/[id]/tasks?view=gantt` — получить задачи для Gantt

## API endpoints

### Основные операции

- `GET /api/pm/tasks` — список задач (с фильтрацией и пагинацией)
- `POST /api/pm/tasks` — создать задачу
- `GET /api/pm/tasks/[id]` — получить задачу
- `PATCH /api/pm/tasks/[id]` — обновить задачу
- `DELETE /api/pm/tasks/[id]` — удалить задачу

### Массовые операции

- `POST /api/pm/tasks/bulk` — массовое обновление задач

### Зависимости

- `GET /api/pm/tasks/[id]/dependencies` — зависимости задачи
- `POST /api/pm/tasks/[id]/dependencies` — создать зависимость
- `DELETE /api/pm/tasks/[id]/dependencies/[depId]` — удалить зависимость

### Комментарии

- `GET /api/pm/tasks/[id]/comments` — комментарии задачи
- `POST /api/pm/tasks/[id]/comments` — создать комментарий

**См. также:**

- [`comments.md`](./projects-tasks-comments.md) — документация по комментариям

## Связанные документы

- [`_module.md`](./projects-tasks-overview.md) — обзор модуля PM Core
- [`projects.md`](./projects-tasks-projects.md) — документация по проектам
- [`comments.md`](./projects-tasks-comments.md) — комментарии к задачам
- [`kanban.md`](./projects-tasks-kanban.md) — Kanban представление

---

**Последнее обновление:** 2026-01-06