# Проекты и задачи — Чат

**Статус:** stable  
**Владелец:** product  
**Создан:** 2026-01-06  
**Последнее обновление:** 2026-01-06

## Введение

Командный чат проекта позволяет участникам проекта общаться в реальном времени, обсуждать задачи, делиться информацией. Чат поддерживает прикрепление файлов, упоминания пользователей и AI-агентов, real-time обновления через WebSocket или polling.

**Статус реализации:** ✅ Завершён (Stage J)

## Структура сообщения

### Поля сообщения

```typescript
interface ProjectChatMessage {
  id: ID;
  projectId: ID;
  authorId: ID;
  body: string; // Текст сообщения
  attachments: ID[]; // Массив ID прикрепленных файлов
  createdAt: string;
  updatedAt: string;
}
```

### Типы сообщений

- **Обычное сообщение** — текстовое сообщение от пользователя
- **Сообщение с файлами** — сообщение с прикрепленными файлами
- **Сообщение от AI-агента** — автоматический ответ AI-агента на упоминание

## Отправка и получение сообщений

### Отправка сообщения

**API endpoint:**
- `POST /api/pm/projects/[id]/chat`

**Обязательные поля:**
- `body` (string) — текст сообщения

**Опциональные поля:**
- `attachments` (ID[]) — массив ID прикрепленных файлов

**Права доступа:**
- `owner` — может отправлять сообщения
- `manager` — может отправлять сообщения
- `contributor` — может отправлять сообщения
- `viewer` — может отправлять сообщения (только просмотр проекта)

**Автоматические действия:**
- При упоминании пользователя генерируется уведомление
- При упоминании AI-агента агент автоматически отвечает (если настроен)

### Получение истории чата

**API endpoint:**
- `GET /api/pm/projects/[id]/chat`

**Параметры запроса:**
- `limit` (number) — количество сообщений на странице (по умолчанию 50)
- `before` (string) — ID сообщения для пагинации (получить сообщения до этого ID)
- `after` (string) — ID сообщения для пагинации (получить сообщения после этого ID)

**Пагинация:**
- Поддержка infinite scroll для загрузки истории
- Сообщения загружаются порциями по 50 сообщений
- Сортировка по дате создания (новые внизу)

## Упоминания пользователей (@mentions)

### Формат упоминаний

В тексте сообщения можно упомянуть пользователя, используя формат `@username` или `@имя пользователя`.

**Обработка:**
- При сохранении сообщения упоминания извлекаются из текста
- Генерируются уведомления для упомянутых пользователей
- Упоминания выделяются в UI

### Упоминания AI-агентов

При упоминании AI-агента в формате `@agent-name`:
- AI-агент автоматически обрабатывает сообщение
- Генерируется ответ от имени агента
- Ответ добавляется в чат как обычное сообщение

**См. также:**
- [`../ai-hub/ai-hub-assistant.md`](../ai-hub/ai-hub-assistant.md) — гайд по AI-ассистенту

## Файлы в чате

### Прикрепление файлов

**Процесс:**
1. Пользователь загружает файл через файловый менеджер
2. Файл прикрепляется к сообщению через поле `attachments`
3. Файл отображается в сообщении

**API endpoint:**
- `POST /api/files` — загрузить файл
- При создании сообщения указать `attachments: [fileId]`

**См. также:**
- [`files.md`](./projects-tasks-files.md) — документация по файловому менеджеру

### Отображение файлов

- Файлы отображаются в сообщении как список вложений
- Поддерживается предпросмотр изображений и PDF
- Файлы можно скачать или открыть в новом окне

## Интеграция с UI

### Компонент ProjectChat

Основной компонент для отображения чата проекта.

**Функции:**
- Отображение истории сообщений с infinite scroll
- Форма отправки сообщения
- Прикрепление файлов
- Автопрокрутка к новым сообщениям
- Polling для обновления (каждые 5 секунд) или WebSocket

### Интеграция в страницу проекта

Чат отображается на странице проекта (`/pm/projects/[id]`) во вкладке "Чат":
- Вкладка доступна только участникам проекта (owner/admin/member)
- Чат загружается автоматически при открытии вкладки
- Real-time обновления через WebSocket или polling

## Real-time обновления

### WebSocket

Если WebSocket сервер доступен:
- Сообщения обновляются мгновенно
- Новые сообщения появляются без перезагрузки страницы
- Событие `chat.message` рассылается всем подключенным клиентам

**См. также:**
- [`websocket.md`](./projects-tasks-websocket.md) — документация по WebSocket

### Polling fallback

Если WebSocket недоступен:
- Используется polling каждые 5 секунд
- Новые сообщения загружаются автоматически
- Плавный переход между режимами

## Интеграция с уведомлениями

При отправке сообщения:
- Генерируется уведомление для участников проекта (если настроено)
- При упоминании пользователя генерируется отдельное уведомление
- Уведомление содержит ссылку на чат проекта

**См. также:**
- [`notifications.md`](./projects-tasks-notifications.md) — документация по уведомлениям

## API endpoints

### Основные операции

- `GET /api/pm/projects/[id]/chat` — получить историю сообщений
- `POST /api/pm/projects/[id]/chat` — отправить сообщение

### Управление сообщениями

- `PATCH /api/pm/projects/[id]/chat/[messageId]` — обновить сообщение (планируется)
- `DELETE /api/pm/projects/[id]/chat/[messageId]` — удалить сообщение (планируется)

### Параметры запроса

**GET /api/pm/projects/[id]/chat:**
- `limit` (number) — количество сообщений (по умолчанию 50)
- `before` (string) — ID сообщения для пагинации назад
- `after` (string) — ID сообщения для пагинации вперед

## Связанные документы

- [`_module.md`](./projects-tasks-overview.md) — обзор модуля PM Core
- [`projects.md`](./projects-tasks-projects.md) — документация по проектам
- [`files.md`](./projects-tasks-files.md) — файлы в чате
- [`notifications.md`](./projects-tasks-notifications.md) — уведомления о сообщениях
- [`websocket.md`](./projects-tasks-websocket.md) — real-time обновления
- [`_implementation-plan.md`](./projects-tasks-implementation-plan.md#stage-j) — Stage J: Чат проекта

---

**Последнее обновление:** 2026-01-06