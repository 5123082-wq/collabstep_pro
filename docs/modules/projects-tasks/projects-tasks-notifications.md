# Проекты и задачи — Уведомления

**Статус:** 95% завершён  
**Владелец:** product  
**Создан:** 2026-01-06  
**Последнее обновление:** 2026-01-06

## Введение

Система уведомлений информирует пользователей о важных событиях в проектах: создание задач, комментарии, назначения, приближающиеся дедлайны. Уведомления отображаются в панели уведомлений и на странице уведомлений с фильтрацией и управлением.

**Статус реализации:** ✅ 95% завершён (Stage I)

## Структура уведомления

### Поля уведомления

```typescript
interface Notification {
  id: ID;
  userId: ID; // Получатель уведомления
  type: NotificationType;
  status: NotificationStatus; // unread, read, archived
  title: string;
  message: string;
  payload?: unknown; // Дополнительные данные (ID задачи, проекта и т.д.)
  createdAt: string;
  readAt?: string;
}
```

### Типы уведомлений

- **`task_assigned`** — задача назначена пользователю
- **`task_updated`** — задача обновлена
- **`comment_added`** — добавлен комментарий к задаче
- **`comment_mentioned`** — пользователь упомянут в комментарии
- **`deadline_approaching`** — приближается дедлайн задачи
- **`project_invite`** — приглашение в проект

### Статусы уведомлений

- **`unread`** — непрочитанное уведомление
- **`read`** — прочитанное уведомление
- **`archived`** — архивированное уведомление

## Генерация уведомлений

### События, генерирующие уведомления

**Задачи:**

- Создание задачи → уведомление для участников проекта
- Назначение задачи → уведомление для назначенного пользователя
- Обновление задачи → уведомление для участников задачи

**Комментарии:**

- Добавление комментария → уведомление для участников задачи
- Упоминание пользователя → уведомление для упомянутого пользователя

**Дедлайны:**

- Приближение дедлайна → уведомление для назначенного пользователя (планируется автоматическая проверка)

**Приглашения:**

- Приглашение в проект → уведомление для приглашенного пользователя (функция готова, но нет POST endpoint)

### Генератор событий

Уведомления генерируются через `event-generator.ts`:

```typescript
// Примеры функций генерации
notifyTaskAssigned(taskId, assigneeId, projectId);
notifyTaskUpdated(taskId, projectId);
notifyCommentAdded(commentId, taskId, projectId);
notifyCommentMentioned(commentId, mentionedUserId, taskId);
notifyDeadlineApproaching(taskId, assigneeId);
notifyProjectInvite(projectId, invitedUserId, inviterId);
```

**См. также:**

- `apps/web/lib/notifications/event-generator.ts` — генератор событий

## Доставка уведомлений

### In-app уведомления

Уведомления отображаются в приложении:

- **Панель уведомлений** — боковая панель с последними уведомлениями
- **Страница уведомлений** — `/app/notifications` с полным списком
- **Счётчик непрочитанных** — badge на иконке уведомлений в навигации

### Обновление счётчика

Счётчик непрочитанных уведомлений обновляется автоматически:

- **Polling** — каждые 30 секунд (если WebSocket недоступен)
- **WebSocket** — мгновенное обновление (если WebSocket доступен)

**См. также:**

- [`websocket.md`](./projects-tasks-websocket.md) — real-time обновления через WebSocket

### Email уведомления

**Статус:** ⚠️ Планируется

В будущем планируется добавить отправку уведомлений на email:

- Интеграция с email сервисом (SendGrid, AWS SES)
- Настройки подписки на типы уведомлений
- Отправка уведомлений на email при критических событиях

### Push уведомления

**Статус:** ⚠️ Планируется

В будущем планируется добавить браузерные push уведомления:

- Service Worker для браузерных push уведомлений
- Интеграция с браузерными API
- Настройки разрешений

## Управление уведомлениями

### Чтение уведомлений

**API endpoint:**

- `PATCH /api/notifications/[id]` — отметить уведомление как прочитанное

**Действия:**

- Статус уведомления меняется с `unread` на `read`
- Счётчик непрочитанных уменьшается
- Уведомление скрывается из списка непрочитанных

### Массовое чтение

**API endpoint:**

- `POST /api/notifications/mark-all-read` — отметить все уведомления как прочитанные

**Действия:**

- Все непрочитанные уведомления пользователя отмечаются как прочитанные
- Счётчик непрочитанных обнуляется

### Удаление уведомлений

**API endpoint:**

- `DELETE /api/notifications/[id]` — удалить уведомление

**Действия:**

- Уведомление удаляется из базы данных
- Уведомление больше не отображается в списке

### Архивирование уведомлений

**Статус:** ⚠️ Планируется

В будущем планируется добавить архивирование уведомлений:

- Перемещение уведомлений в архив
- Просмотр архивированных уведомлений
- Автоматическое архивирование старых уведомлений

## Настройки уведомлений

**Статус:** ⚠️ Планируется

В будущем планируется добавить настройки уведомлений:

- Выбор типов уведомлений для получения
- Настройка частоты уведомлений
- Настройка каналов доставки (in-app, email, push)

## UI компоненты

### NotificationsPanel

Боковая панель с последними уведомлениями.

**Функции:**

- Отображение последних 10 непрочитанных уведомлений
- Счётчик непрочитанных
- Клик по уведомлению → переход к связанной сущности
- Кнопка "Показать все" → переход на страницу уведомлений

### Страница уведомлений

Полноценная страница `/app/notifications` с управлением уведомлениями.

**Функции:**

- Список всех уведомлений с пагинацией
- Фильтрация по типу и статусу
- Поиск по тексту уведомления
- Массовые операции (отметить все как прочитанные, удалить)
- Сортировка по дате

## Интеграция

### Интеграция с задачами

При создании/обновлении задачи:

- Генерируется уведомление для участников задачи
- Уведомление содержит ссылку на задачу
- Клик по уведомлению открывает задачу

### Интеграция с комментариями

При создании комментария:

- Генерируется уведомление для участников задачи
- При упоминании пользователя генерируется отдельное уведомление
- Уведомление содержит ссылку на комментарий

**См. также:**

- [`comments.md`](./projects-tasks-comments.md) — документация по комментариям

### Интеграция с WebSocket

Уведомления обновляются в реальном времени через WebSocket:

- При создании нового уведомления все открытые клиенты получают событие
- Счётчик непрочитанных обновляется мгновенно
- UI автоматически обновляется без перезагрузки страницы

**См. также:**

- [`websocket.md`](./projects-tasks-websocket.md) — документация по WebSocket

## API endpoints

### Основные операции

- `GET /api/notifications` — получить список уведомлений пользователя
- `PATCH /api/notifications/[id]` — отметить уведомление как прочитанное
- `DELETE /api/notifications/[id]` — удалить уведомление

### Дополнительные операции

- `POST /api/notifications/mark-all-read` — отметить все как прочитанные
- `GET /api/notifications/unread-count` — получить количество непрочитанных

### Параметры запроса

**GET /api/notifications:**

- `status` (string) — фильтр по статусу (unread, read, archived)
- `type` (string) — фильтр по типу уведомления
- `limit` (number) — количество уведомлений на странице
- `offset` (number) — смещение для пагинации

## Оставшиеся задачи

### POST endpoint для приглашения участников

**Статус:** ⚠️ Функция готова, но нет POST endpoint

Функция `notifyProjectInvite` реализована, но не интегрирована, так как отсутствует POST endpoint для добавления участников проекта.

### Автоматическая проверка дедлайнов

**Статус:** ⚠️ Функция готова, но не интегрирована

Функция `notifyDeadlineApproaching` готова к использованию, но автоматическая проверка дедлайнов не интегрирована. Можно добавить cron job или проверку при загрузке страницы.

## Связанные документы

- [`_module.md`](./projects-tasks-overview.md) — обзор модуля PM Core
- [`tasks.md`](./projects-tasks-tasks.md) — уведомления о задачах
- [`comments.md`](./projects-tasks-comments.md) — уведомления о комментариях
- [`websocket.md`](./projects-tasks-websocket.md) — real-time обновления
- [`_implementation-plan.md`](./projects-tasks-implementation-plan.md#stage-i) — Stage I: Система уведомлений

---

**Последнее обновление:** 2026-01-06