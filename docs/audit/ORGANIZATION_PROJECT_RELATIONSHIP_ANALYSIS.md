# Анализ связи организаций и проектов

**Дата анализа:** 2026-01-05  
**Проблема:** Что произойдет при создании новой организации у пользователя Админ?

## Текущая ситуация

### Организация `acct-collabverse`

- **В памяти:** ✅ Существует (`memory.ORGANIZATIONS[0]`)
- **В БД:** ⚠️ Создается автоматически только при обращении через `organizationsRepository.findById()`
- **Статус:** Организация синхронизируется автоматически, но не существует в БД до первого обращения

### Проекты (48 штук)

- **В БД:** ✅ Все проекты в таблице `pm_projects`
- **Связь с организацией:** ⚠️ **ПРОБЛЕМА** - в таблице `pm_projects` **НЕТ поля `organization_id`**
- **Связь хранится в:** Таблица `projects` (Drizzle схема), которая **помечена как deprecated**

### Структура таблицы `pm_projects`

```sql
CREATE TABLE pm_projects (
  id TEXT PRIMARY KEY,
  workspace_id TEXT NOT NULL,
  key TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  owner_id TEXT NOT NULL,  -- Связь с пользователем
  status TEXT NOT NULL,
  visibility TEXT NOT NULL,
  -- ❌ НЕТ organization_id!
  ...
);
```

### Как создается связь проекта с организацией

1. **Проект создается** через `projectsRepository.create()` → записывается в `pm_projects` (БЕЗ `organization_id`)

2. **Связь создается** через `upsertOrganizationProject()` → записывается в таблицу `projects` (Drizzle, deprecated):

```typescript
// apps/web/app/api/pm/projects/route.ts
await upsertOrganizationProject({
  projectId: project.id,
  organizationId,  // Сохраняется в таблице projects (deprecated)
  ownerId: auth.userId,
  title: project.title,
  ...
});
```

3. **Проблема:** Таблица `projects` помечена как deprecated и не используется как источник истины!

## Что произойдет при создании новой организации

### Сценарий: Пользователь Админ создает новую организацию

1. **Новая организация создается** в БД через `organizationsRepository.create()`
2. **Старая организация `acct-collabverse`** остается только в памяти (если не обращаться через репозиторий)
3. **Существующие проекты (48 штук):**
   - Останутся в таблице `pm_projects` БЕЗ связи с организацией
   - Связь со старой организацией останется в deprecated таблице `projects`
   - **НЕ БУДУТ ВИДНЫ** при фильтрации по новой организации

4. **Новые проекты:**
   - Будут созданы в `pm_projects` БЕЗ `organization_id`
   - Связь с новой организацией будет создана в deprecated таблице `projects`
   - Будут видны только при обращении через deprecated таблицу

### Проблемы

1. **Нет единого источника истины** для связи проектов с организациями
2. **Проекты не фильтруются по организации** из `pm_projects` (нет поля `organization_id`)
3. **Связь хранится в deprecated таблице**, которая не используется как источник истины
4. **При создании новой организации** существующие проекты "теряются" для новой организации

## Рекомендации

### 1. Перенести организацию из памяти в БД (КРИТИЧНО)

**Текущее состояние:** Организация создается автоматически при обращении через репозиторий, но не существует в БД до первого обращения.

**Решение:** Создать скрипт для явной синхронизации организации в БД:

```typescript
// scripts/sync-organization-to-db.ts уже существует
// Но нужно убедиться, что организация создается при старте приложения
```

**Действие:** Запустить скрипт синхронизации или убедиться, что организация создается при первом обращении.

### 2. Добавить поле `organization_id` в таблицу `pm_projects` (КРИТИЧНО)

**Проблема:** В таблице `pm_projects` нет поля `organization_id`, поэтому проекты не могут быть связаны с организациями напрямую.

**Решение:**

1. Добавить миграцию для добавления поля `organization_id`:

```sql
ALTER TABLE pm_projects
ADD COLUMN IF NOT EXISTS organization_id TEXT;

-- Создать индекс для быстрого поиска проектов по организации
CREATE INDEX IF NOT EXISTS idx_pm_projects_organization_id
ON pm_projects(organization_id);
```

2. Обновить существующие проекты, связав их с организацией `acct-collabverse`:

```sql
-- Обновить все существующие проекты
UPDATE pm_projects
SET organization_id = 'acct-collabverse'
WHERE organization_id IS NULL;
```

3. Обновить код создания проектов, чтобы сохранять `organization_id` в `pm_projects`:

```typescript
// В функции persistProjectToPg или при создании проекта
await sql.query(`
  INSERT INTO pm_projects (id, workspace_id, key, title, owner_id, organization_id, ...)
  VALUES ($1, $2, $3, $4, $5, $6, ...)
`, [projectId, workspaceId, key, title, ownerId, organizationId, ...]);
```

### 3. Обновить репозиторий проектов для фильтрации по организации

**Текущее состояние:** `projectsRepository.list()` не фильтрует проекты по организации.

**Решение:** Добавить параметр `organizationId` в метод `list()`:

```typescript
async list(options: {
  archived?: boolean | null;
  workspaceId?: string | null;
  organizationId?: string | null;  // НОВЫЙ ПАРАМЕТР
} = {}): Promise<Project[]> {
  // При чтении из БД добавить фильтр:
  if (organizationId) {
    dbProjects = dbProjects.filter(p => p.organizationId === organizationId);
  }
}
```

### 4. Убрать зависимость от deprecated таблицы `projects`

**Текущее состояние:** Связь проектов с организациями хранится в deprecated таблице `projects`.

**Решение:**

1. После добавления `organization_id` в `pm_projects` убрать использование `upsertOrganizationProject()`
2. Обновить код создания проектов, чтобы сразу сохранять `organization_id` в `pm_projects`
3. Удалить или пометить как deprecated функцию `upsertOrganizationProject()`

## План действий

### Немедленные действия (критично)

1. ✅ **Перенести организацию в БД** - запустить скрипт синхронизации или убедиться, что она создается автоматически
2. ⚠️ **Добавить поле `organization_id` в `pm_projects`** - создать миграцию
3. ⚠️ **Обновить существующие проекты** - связать все 48 проектов с организацией `acct-collabverse`
4. ⚠️ **Обновить код создания проектов** - сохранять `organization_id` при создании

### Долгосрочные улучшения

1. Обновить репозиторий проектов для фильтрации по организации
2. Убрать зависимость от deprecated таблицы `projects`
3. Добавить валидацию при создании проекта (проверка существования организации)
4. Добавить тесты для проверки связи проектов с организациями

## Выводы

**Ответ на вопрос:** При создании новой организации у пользователя Админ:

1. ✅ Новая организация будет создана в БД
2. ⚠️ Существующие проекты останутся связанными со старой организацией через deprecated таблицу
3. ❌ Проекты НЕ БУДУТ ВИДНЫ при фильтрации по новой организации (так как в `pm_projects` нет `organization_id`)
4. ⚠️ Новые проекты будут созданы БЕЗ связи с организацией в канонической таблице `pm_projects`

**Рекомендация:** **ДА, имеет смысл перенести организацию из памяти в БД И добавить поле `organization_id` в таблицу `pm_projects`** для обеспечения корректной связи проектов с организациями.
