# Отчет о расположении данных в системе

**Дата аудита:** 2026-01-05  
**Скрипт:** `scripts/comprehensive-data-audit.ts`

## Резюме

Аудит данных показал следующее распределение:

| Тип данных | Всего найдено | Только в БД | Только в памяти | В БД и памяти |
|------------|---------------|-------------|-----------------|---------------|
| **Организации** | 1 | 0 | 1 | 0 |
| **Проекты** | 48 | 48 | 0 | 0 |
| **Задачи** | 38 | 38 | 0 | 0 |
| **ИТОГО** | **87** | **86** | **1** | **0** |

## Детальный анализ

### 1. Организации

#### Найдено: 1 организация

| ID | Название | Расположение | Таблица БД | Ключ памяти | Источник | Как попало |
|----|----------|--------------|------------|-------------|----------|------------|
| `acct-collabverse` | Collabverse Demo Org | **Только в памяти** | N/A | `memory.ORGANIZATIONS` | Memory | Инициализация при старте приложения |

**Проблема:** Организация существует только в памяти, но не в БД. Это может быть причиной того, что организация "исчезает" при перезапуске сервера.

**Пути хранения:**
- ✅ Память: `memory.ORGANIZATIONS[0]`
- ❌ БД (Drizzle): таблица `organization` - **НЕ НАЙДЕНО**
- ❌ БД (SQL): таблица `organization` - **НЕ НАЙДЕНО**
- ✅ Репозиторий: `organizationsRepository.listForUser()` - **НАЙДЕНО**

### 2. Проекты

#### Найдено: 48 проектов

**Расположение:** Все проекты находятся **только в БД** (таблица `pm_projects`)

**Пути хранения:**
- ✅ БД (SQL): таблица `pm_projects` - **48 проектов**
- ❌ БД (Drizzle): таблица `project` - **0 проектов** (не синхронизированы)
- ❌ Память: `memory.PROJECTS` - **0 проектов** (не загружены в память)
- ❌ Репозиторий: `projectsRepository.list()` - **0 проектов** (работает с памятью)

**Как попало в БД:**
- Проекты создаются через `upsertOrganizationProject()` в `project-template-service.ts`
- Записываются напрямую в таблицу `pm_projects` через SQL
- НЕ синхронизируются с Drizzle схемой `project`
- НЕ загружаются в память автоматически

**Примеры проектов:**
- `Бренд-пакет` (319c987a-155f-4064-acf0-912211e812cd) - создан из шаблона
- 47 проектов `Test Project` - тестовые проекты, созданные при разработке

### 3. Задачи

#### Найдено: 38 задач

**Расположение:** Все задачи находятся **только в БД** (таблица `pm_tasks`)

**Пути хранения:**
- ✅ БД (SQL): таблица `pm_tasks` - **38 задач**
- ❌ Память: `memory.TASKS` - **0 задач** (не загружены в память)
- ❌ Репозиторий: `tasksRepository.list()` - **0 задач** (работает с памятью)

**Как попало в БД:**
- Задачи создаются через `tasksRepository.create()`
- Записываются в БД через `persistTaskToPg()` в `pm-pg-adapter.ts`
- НЕ загружаются в память автоматически при старте

**Типы задач:**
- 16 задач из шаблона "Бренд-пакет" (исследование, разработка логотипа, документация и т.д.)
- 22 задачи "Test Task" - тестовые задачи

## Проблемы и несоответствия

### Критические проблемы

1. **Организация только в памяти**
   - Организация `acct-collabverse` существует только в памяти
   - При перезапуске сервера организация "исчезает"
   - Нужно синхронизировать с БД

2. **Проекты не синхронизированы**
   - 48 проектов в БД (`pm_projects`), но 0 в памяти
   - Репозиторий `projectsRepository.list()` возвращает пустой список
   - Проекты создаются напрямую в БД, минуя память

3. **Задачи не синхронизированы**
   - 38 задач в БД (`pm_tasks`), но 0 в памяти
   - Репозиторий `tasksRepository.list()` возвращает пустой список
   - Задачи создаются в БД, но не загружаются в память

### Архитектурные несоответствия

1. **Два пути хранения проектов:**
   - Drizzle схема `project` (таблица `project`) - **не используется**
   - Прямой SQL `pm_projects` - **используется**
   - Нет синхронизации между ними

2. **Память не синхронизирована с БД:**
   - Данные создаются в БД, но не загружаются в память
   - Репозитории работают с памятью, но память пуста
   - Нужна гидратация памяти из БД при старте

## Рекомендации

### Немедленные действия

1. **Синхронизировать организацию с БД:**
   ```typescript
   // Создать организацию в БД через Drizzle
   await db.insert(organizations).values({
     id: 'acct-collabverse',
     name: 'Collabverse Demo Org',
     ownerId: '00000000-0000-0000-0000-000000000001',
     // ... другие поля
   });
   ```

2. **Загрузить проекты в память:**
   ```typescript
   // Использовать pmPgHydration для загрузки проектов из БД
   await pmPgHydration;
   ```

3. **Загрузить задачи в память:**
   ```typescript
   // Задачи должны загружаться через pmPgHydration
   ```

### Долгосрочные улучшения

1. **Унифицировать хранение проектов:**
   - Использовать только Drizzle схему `project`
   - Или мигрировать все проекты из `pm_projects` в `project`

2. **Обеспечить синхронизацию памяти и БД:**
   - Автоматическая гидратация при старте приложения
   - Синхронизация при создании/обновлении данных

3. **Документировать архитектуру хранения:**
   - Где какие данные хранятся
   - Как происходит синхронизация
   - Когда использовать память, когда БД

## Таблица путей хранения

| Тип данных | БД (Drizzle) | БД (SQL) | Память | Репозиторий | Статус |
|------------|-------------|----------|--------|-------------|--------|
| **Организации** | `organization` (0) | `organization` (0) | `memory.ORGANIZATIONS` (1) | `organizationsRepository` (1) | ⚠️ Только память |
| **Проекты** | `project` (0) | `pm_projects` (48) | `memory.PROJECTS` (0) | `projectsRepository` (0) | ⚠️ Только БД |
| **Задачи** | N/A | `pm_tasks` (38) | `memory.TASKS` (0) | `tasksRepository` (0) | ⚠️ Только БД |

**Легенда:**
- ✅ Работает корректно
- ⚠️ Есть проблемы синхронизации
- ❌ Не используется/не найдено

## Выводы

1. **Данные разрознены** - проекты и задачи в БД, но не в памяти
2. **Организация в памяти** - может "исчезать" при перезапуске
3. **Репозитории не работают** - возвращают пустые списки, т.к. память пуста
4. **Нужна синхронизация** - между БД и памятью при старте приложения

## Следующие шаги

1. Запустить `pmPgHydration` для загрузки данных из БД в память
2. Создать организацию в БД через Drizzle
3. Проверить, что репозитории возвращают данные после гидратации
4. Убедиться, что новые данные синхронизируются между БД и памятью

