# Руководство по очистке базы данных пользователей

## Обзор

Это руководство описывает процесс очистки базы данных пользователей и настройки системы для работы только с демо-администратором `admin.demo@collabverse.test`.

## Цель

- Удалить всех пользователей кроме `admin.demo@collabverse.test`
- Переназначить все организации и проекты на демо-администратора
- Настроить систему для корректной работы с одним администратором
- Обеспечить правильную работу формы регистрации для создания новых пользователей

## Предварительные требования

1. Доступ к базе данных Vercel Postgres
2. Переменные окружения настроены в `.env.local`
3. Установлены все зависимости проекта

## Шаги выполнения

### 1. Запуск скрипта очистки

```bash
cd /Users/macbookaleks/Documents/GitHub/collabstep-new-3
npx tsx scripts/cleanup-users-db.ts
```

Скрипт выполнит следующие действия:

1. **Проверка администратора** - найдет или создаст `admin.demo@collabverse.test` с ID `00000000-0000-0000-0000-000000000001`
2. **Переназначение организаций** - все организации будут переназначены на демо-администратора
3. **Переназначение проектов** - все проекты будут переназначены на демо-администратора
4. **Обновление приглашений** - все приглашения будут обновлены
5. **Обновление контрактов** - все контракты будут обновлены
6. **Удаление пользователей** - все пользователи кроме администратора будут удалены (CASCADE удалит связанные записи)
7. **Настройка прав** - права администратора будут настроены в `userControls`

### 2. Проверка результата

После выполнения скрипта вы должны увидеть:

```
✅ База данных очищена успешно
Администратор: Алина Админ (admin.demo@collabverse.test)
ID: 00000000-0000-0000-0000-000000000001
Пароль установлен: ✅
```

### 3. Вход в систему

Используйте следующие данные для входа:

- **Email**: `admin.demo@collabverse.test`
- **Пароль**: `admin.demo` (или значение из `DEMO_ADMIN_PASSWORD`)

## Структура базы данных

### Таблицы, связанные с пользователями

Следующие таблицы автоматически очищаются при удалении пользователей (CASCADE):

- `account` - OAuth аккаунты
- `session` - сессии пользователей
- `userControl` - настройки прав пользователей
- `performer_profile` - профили исполнителей
- `organization_member` - члены организаций
- `project_member` - члены проектов
- `organization_invite` - приглашения в организации
- `project_invite` - приглашения в проекты

### Таблицы, требующие переназначения

Следующие таблицы требуют переназначения перед удалением пользователей:

- `organization` - владелец организации (`ownerId`)
- `project` - владелец проекта (`ownerId`)
- `contract` - исполнитель контракта (`performerId`)

Скрипт автоматически переназначает все эти записи на демо-администратора.

## Форма регистрации

После очистки базы данных новые пользователи могут регистрироваться через форму регистрации:

1. Перейдите на `/register`
2. Заполните форму:
   - Имя (обязательно)
   - Email (обязательно, не может быть `admin.demo@collabverse.test` или `user.demo@collabverse.test`)
   - Пароль (минимум 6 символов)
   - Должность (опционально)
3. После регистрации пользователь будет создан в базе данных с:
   - Случайным UUID
   - Записью в `userControls` со статусом `active` и пустыми ролями
   - Хэшированным паролем

## API маршруты

Все API маршруты проверяют авторизацию и права доступа:

- **Административные маршруты** (`/api/admin/*`) - требуют роль `admin`
- **Проектные маршруты** (`/api/pm/*`) - требуют доступ к проекту
- **Финансовые маршруты** (`/api/finance/*`) - требуют соответствующие права

Демо-администратор имеет роли:
- `productAdmin`
- `featureAdmin`

## Важные замечания

1. **Резервное копирование**: Перед запуском скрипта рекомендуется создать резервную копию базы данных
2. **Тестовые пользователи**: Скрипт удаляет всех пользователей кроме `admin.demo@collabverse.test`, включая других тестовых пользователей
3. **AI-агенты**: AI-агенты (email заканчивается на `@collabverse.ai`) также будут удалены, если они не являются администратором
4. **Организации и проекты**: Все организации и проекты будут переназначены на демо-администратора

## Устранение неполадок

### Ошибка: "Foreign key constraint violation"

Если вы получили ошибку о нарушении внешнего ключа:

1. Проверьте, что все организации и проекты переназначены
2. Убедитесь, что скрипт выполнил все шаги переназначения
3. Попробуйте запустить скрипт еще раз

### Ошибка: "User not found"

Если администратор не найден:

1. Проверьте подключение к базе данных
2. Убедитесь, что переменные окружения настроены правильно
3. Проверьте, что таблица `user` существует

### Ошибка: "Permission denied"

Если вы получили ошибку доступа:

1. Проверьте права доступа к базе данных
2. Убедитесь, что используете правильные учетные данные

## Дополнительная информация

- **ID администратора**: `00000000-0000-0000-0000-000000000001` (константа `TEST_ADMIN_USER_ID`)
- **Email администратора**: `admin.demo@collabverse.test`
- **Функция проверки**: `isAdminUserId(userId)` проверяет, является ли пользователь администратором

## Связанные файлы

- `scripts/cleanup-users-db.ts` - скрипт очистки базы данных
- `apps/web/lib/auth/init-demo-accounts.ts` - инициализация демо-аккаунтов
- `apps/api/src/repositories/users-db-repository.ts` - репозиторий пользователей
- `apps/web/app/api/auth/register/route.ts` - API регистрации

