# Текущее состояние шаблонов проектов

## Где хранятся

**Файл:** `apps/api/src/data/memory.ts` (строки 342-353)

**Хранение:** В памяти как массив `memory.TEMPLATES`

**Репозиторий:** `apps/api/src/repositories/templates-repository.ts`

- Методы: `list()`, `findById(id)`
- Нет методов для создания/обновления/удаления

**API:**

- `GET /api/templates` - только чтение
- Нет POST/PUT/DELETE endpoints

## Структура шаблона

```typescript
interface ProjectTemplate {
  id: string; // Уникальный идентификатор (например, 'tpl-admin-discovery')
  title: string; // Название шаблона
  kind: string; // Тип: 'product', 'brand', 'landing', 'marketing'
  summary: string; // Краткое описание
}
```

## Текущие шаблоны (5 штук)

1. **Админский discovery**
   - ID: `tpl-admin-discovery`
   - Тип: `product`
   - Описание: "Скрипты интервью, CJM и гипотезы для старта команды."

2. **Бренд-пакет**
   - ID: `tpl-brand`
   - Тип: `brand`
   - Описание: "Нейминг, айдентика, гайд"

3. **Лендинг**
   - ID: `tpl-landing`
   - Тип: `landing`
   - Описание: "Одностраничник с формой"

4. **Маркетинг**
   - ID: `tpl-mkt`
   - Тип: `marketing`
   - Описание: "Кампания + контент-план"

5. **Digital-продукт**
   - ID: `tpl-product`
   - Тип: `product`
   - Описание: "MVP флоу + бэклог"

## Где используются

1. **Компонент выбора шаблона:**
   - `apps/web/components/pm/ProjectTemplateSelectorModal.tsx`
   - Загружает шаблоны через `/api/templates`
   - Используется при создании проекта

2. **API endpoint:**
   - `apps/web/app/api/templates/route.ts`
   - Только GET метод
   - Возвращает список шаблонов

3. **Сервис каталога:**
   - `apps/api/src/services/project-catalog-service.ts`
   - Метод `getTemplates()` использует `templatesRepository.list()`

## Ограничения

❌ **Нет API для создания/редактирования шаблонов**
❌ **Нет админ-панели для управления шаблонами**
❌ **Нет возможности пользователям создавать свои шаблоны**
❌ **Шаблоны хранятся только в памяти (не в БД)**
❌ **Нет расширенной функциональности (задачи, настройки и т.д.)**

## Планируемая архитектура шаблонов

### Два типа шаблонов

1. **Административные шаблоны** (общие для всех пользователей)
   - Создаются администрацией портала
   - Видны всем пользователям
   - Управление через админ-панель

2. **Пользовательские шаблоны** (личные для каждого пользователя)
   - Создаются пользователями для себя
   - Видны только создателю
   - Управление через раздел "Проекты и задачи" → вкладка "Мои шаблоны"

## Что нужно для реализации

### Этап 1: Административные шаблоны (админ-панель)

1. **API endpoints для админа:**
   - `GET /api/admin/templates` - список всех административных шаблонов
   - `POST /api/admin/templates` - создание административного шаблона
   - `PUT /api/admin/templates/[id]` - обновление административного шаблона
   - `DELETE /api/admin/templates/[id]` - удаление административного шаблона

2. **Расширение репозитория административных шаблонов:**
   - `TemplatesRepository.create(template)` - создание
   - `TemplatesRepository.update(id, template)` - обновление
   - `TemplatesRepository.delete(id)` - удаление
   - Хранение: пока в памяти (`memory.TEMPLATES`), позже миграция в БД

3. **Админ-страница:**
   - `apps/web/app/(app)/admin/templates/page.tsx`
   - Список всех административных шаблонов
   - Форма создания нового шаблона
   - Форма редактирования существующего шаблона
   - Удаление шаблонов
   - Добавить ссылку в главное меню админ-панели (`apps/web/app/(app)/admin/page.tsx`)

4. **Обновление API для пользователей:**
   - `GET /api/templates` - должен возвращать **объединенный список**:
     - Административные шаблоны (для всех)
     - Пользовательские шаблоны текущего пользователя (только его)

### Этап 2: Пользовательские шаблоны

5. **Структура хранения пользовательских шаблонов:**
   - **Вариант А (рекомендуемый):** Таблица в PostgreSQL
     ```sql
     CREATE TABLE user_project_templates (
       id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
       user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
       title VARCHAR(255) NOT NULL,
       kind VARCHAR(50),
       summary TEXT,
       -- Расширенные поля (для будущего):
       project_type VARCHAR(50),
       project_stage VARCHAR(50),
       project_visibility VARCHAR(20),
       -- Метаданные:
       created_at TIMESTAMP NOT NULL DEFAULT NOW(),
       updated_at TIMESTAMP NOT NULL DEFAULT NOW()
     );
     ```
   - **Вариант Б (временный):** В памяти с привязкой к `userId`
     - `memory.USER_TEMPLATES: Array<{ userId: string, templates: ProjectTemplate[] }>`

6. **API endpoints для пользовательских шаблонов:**
   - `GET /api/pm/templates` - список пользовательских шаблонов текущего пользователя
   - `POST /api/pm/templates` - создание пользовательского шаблона
   - `PUT /api/pm/templates/[id]` - обновление пользовательского шаблона
   - `DELETE /api/pm/templates/[id]` - удаление пользовательского шаблона
   - `POST /api/pm/templates/from-project` - сохранить проект как шаблон

7. **UI для пользовательских шаблонов:**
   - **Расположение:** Раздел "Проекты и задачи" → вкладка "Шаблоны проектов пользователя"
   - **Структура навигации:**
     - В разделе PM (`/pm`) добавить навигацию с вкладками:
       - "Проекты" → `/pm/projects`
       - "Задачи" → `/pm/tasks`
       - "Мои шаблоны" → `/pm/templates` (новый раздел)
   - **Страница:** `apps/web/app/(app)/pm/templates/page.tsx`
   - **Функционал страницы:**
     - Список пользовательских шаблонов (карточки или список)
     - Кнопка "Создать шаблон" (открывает модальное окно с формой)
     - Редактирование шаблона (модальное окно или inline)
     - Удаление шаблона (с подтверждением)
     - Просмотр деталей шаблона
   - **Интеграция с проектами:**
     - На странице проекта (`/pm/projects/[id]/page.tsx`) добавить кнопку/действие:
       - "Сохранить как шаблон" (в меню действий проекта)
       - Открывает модальное окно с формой создания шаблона из проекта
       - Позволяет указать название, описание, тип шаблона
   - **Компоненты:**
     - `apps/web/components/pm/UserTemplatesList.tsx` - список шаблонов
     - `apps/web/components/pm/CreateTemplateModal.tsx` - создание/редактирование
     - `apps/web/components/pm/SaveProjectAsTemplateModal.tsx` - сохранение проекта как шаблон

8. **Репозиторий пользовательских шаблонов:**
   - `UserTemplatesRepository` (новый класс)
   - Методы: `list(userId)`, `findById(id, userId)`, `create(template, userId)`, `update(id, template, userId)`, `delete(id, userId)`

### Этап 3: Расширение функциональности шаблонов

9. **Расширение структуры шаблона (для обоих типов):**

   ```typescript
   interface ProjectTemplate {
     id: string;
     title: string;
     kind: string;
     summary: string;

     // Новые поля:
     projectType?: ProjectType; // Тип проекта (product, marketing, etc.)
     projectStage?: ProjectStage; // Стадия (discovery, design, etc.)
     projectVisibility?: ProjectVisibility; // Видимость (private/public)

     // Задачи в шаблоне (будущее):
     tasks?: Array<{
       title: string;
       description?: string;
       status: TaskStatus;
       // ...
     }>;

     // Метаданные:
     createdBy?: string; // userId для пользовательских шаблонов
     createdAt?: string;
     updatedAt?: string;
   }
   ```

10. **Функция "Сохранить проект как шаблон":**
    - Кнопка на странице проекта (`/pm/projects/[id]`)
    - Форма: название шаблона, описание, тип
    - Сохраняет текущие настройки проекта:
      - Название, описание, тип, стадия
      - Список задач (опционально, в будущем)
    - Создает пользовательский шаблон

11. **Миграция административных шаблонов в БД:**
    - Таблица `admin_project_templates` в PostgreSQL
    - Миграция данных из `memory.TEMPLATES` в БД
    - Обновление `TemplatesRepository` для работы с БД

### Этап 4: Интеграция шаблонов при создании проекта

12. **Обновление выбора шаблона:**
    - `ProjectTemplateSelectorModal` должен показывать:
      - Секция "Рекомендованные" (административные шаблоны)
      - Секция "Мои шаблоны" (пользовательские шаблоны)
    - При выборе шаблона применяются все настройки из шаблона:
      - Тип проекта
      - Стадия проекта
      - Видимость
      - Задачи (если есть)

## Структура файлов

### Административные шаблоны

```
apps/api/src/
  repositories/
    templates-repository.ts (расширить методами create/update/delete)
  data/
    memory.ts (пока храним здесь, потом миграция в БД)

apps/web/app/
  api/admin/templates/
    route.ts (GET, POST)
    [id]/
      route.ts (PUT, DELETE)
  (app)/admin/
    templates/
      page.tsx (админ-панель управления шаблонами)
```

### Пользовательские шаблоны

```
apps/api/src/
  repositories/
    user-templates-repository.ts (новый файл)
  db/
    schema.ts (добавить таблицу user_project_templates)
    migrations/
      XXXX_user_project_templates.sql (миграция)

apps/web/app/
  api/pm/templates/
    route.ts (GET, POST)
    [id]/
      route.ts (PUT, DELETE)
    from-project/
      route.ts (POST - сохранить проект как шаблон)
  (app)/pm/
    templates/
      page.tsx (страница пользовательских шаблонов)
    projects/
      [id]/
        page.tsx (добавить кнопку "Сохранить как шаблон")
```

## Приоритет реализации

### Фаза 1 (высокий приоритет)

1. ✅ Админ-панель для управления административными шаблонами
2. ✅ API endpoints для административных шаблонов (CRUD)
3. ✅ Расширение TemplatesRepository

### Фаза 2 (средний приоритет)

4. ✅ База данных для пользовательских шаблонов
5. ✅ API endpoints для пользовательских шаблонов (CRUD)
6. ✅ UI страница для пользовательских шаблонов
7. ✅ Интеграция в раздел "Проекты и задачи"

### Фаза 3 (низкий приоритет)

8. ✅ Функция "Сохранить проект как шаблон"
9. ✅ Расширение структуры шаблонов (задачи, настройки)
10. ✅ Миграция административных шаблонов в БД

## Важные замечания

- **Разделение:** Административные и пользовательские шаблоны - это **разные сущности**
  - Административные: создаются админами, видны всем
  - Пользовательские: создаются пользователями, видны только создателю

- **Доступ при создании проекта:**
  - В модальном окне выбора шаблона показываются оба типа
  - Раздел "Рекомендованные" - административные шаблоны
  - Раздел "Мои шаблоны" - пользовательские шаблоны текущего пользователя

- **Приватность:**
  - Пользовательские шаблоны видны только создателю
  - Административные шаблоны видны всем пользователям

- **Хранение:**
  - Административные: пока в памяти, потом миграция в БД (таблица `admin_project_templates`)
  - Пользовательские: в БД (таблица `user_project_templates`) с привязкой к `user_id`

- **Навигация:**
  - Административные: управление через `/admin/templates`
  - Пользовательские: управление через `/pm/templates` (в разделе "Проекты и задачи")

- **Расширяемость:**
  - Структура должна быть готова к добавлению задач и других полей в будущем
  - Оба типа шаблонов могут иметь одинаковую расширенную структуру

- **Создание шаблона из проекта:**
  - Пользователь может сохранить любой свой проект как шаблон
  - Сохраняются настройки проекта (название, описание, тип, стадия, видимость)
  - Задачи из проекта можно будет добавить позже (в расширенной версии)
