# ADR-0001: Канонические таблицы для проектов и задач

**Статус:** Принято  
**Дата:** 2026-01-05  
**Авторы:** Database Optimization Plan

## Контекст

В системе существовали два параллельных пути хранения данных проектов и задач:

1. **Drizzle схема** (`project` таблица) - создана в ранних миграциях, но не использовалась в runtime
2. **Прямой SQL** (`pm_projects`, `pm_tasks` таблицы) - созданы динамически через `pm-pg-adapter.ts`, активно используются

Аудит данных показал:
- Таблица `project` (Drizzle) содержит 0 проектов
- Таблица `pm_projects` содержит 48 проектов
- Таблица `pm_tasks` содержит 38 задач
- Репозитории читали из памяти, которая была пуста

Это создавало проблему разрозненности данных и неясности источника истины.

## Решение

**Зафиксировать `pm_projects` и `pm_tasks` как единственные канонические таблицы для проектов и задач.**

### Детали решения

1. **Канонические таблицы:**
   - `pm_projects` - единственная таблица для хранения проектов
   - `pm_tasks` - единственная таблица для хранения задач

2. **Deprecated таблица:**
   - Таблица `project` (Drizzle схема) помечена как `@deprecated`
   - Не используется для новых операций чтения/записи
   - Остается в схеме для обратной совместимости, но не должна использоваться

3. **Репозитории:**
   - `ProjectsRepository.list()` читает из `pm_projects` (БД как источник истины)
   - `TasksRepository.list()` читает из `pm_tasks` (БД как источник истины)
   - Память используется только как кэш (cache-aside паттерн)

## Последствия

### Положительные

- ✅ Единый источник истины для проектов и задач
- ✅ Устранена разрозненность данных
- ✅ Репозитории возвращают актуальные данные из БД
- ✅ Память используется только как кэш, не как хранилище

### Отрицательные

- ⚠️ Таблица `project` остается в схеме (для обратной совместимости)
- ⚠️ Методы репозиториев стали асинхронными (требуют обновления всех мест использования)

### Митигация

- Таблица `project` помечена как deprecated с комментариями
- Репозитории имеют fallback на память, если БД недоступна
- Постепенное обновление мест использования на асинхронные вызовы

## Альтернативы

### Альтернатива 1: Миграция данных из `pm_projects` в `project`

**Отклонено:** Таблица `project` не содержит необходимых полей (`workspace_id`, `key`, `budget_planned`, и т.д.), которые есть в `pm_projects`. Миграция потребовала бы изменения схемы и потери данных.

### Альтернатива 2: Описать `pm_projects`/`pm_tasks` в Drizzle

**Рассмотрено:** Можно было бы описать эти таблицы в Drizzle схеме для использования ORM. Однако текущая реализация через прямой SQL работает стабильно и не требует изменений.

## Связанные документы

- `docs/audit/DATA_LOCATION_AUDIT_REPORT.md` - отчет аудита данных
- `docs/architecture/database-architecture.md` - архитектура БД
- `apps/api/src/storage/pm-pg-adapter.ts` - адаптер для работы с pm таблицами

