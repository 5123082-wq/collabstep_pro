# ADR-0005: Мультиаккаунт через Organizations и Workspaces

**Статус:** Принято  
**Дата:** 2026-01-07  
**Владелец:** engineering  
**Авторы:** Architecture Documentation  
**Последнее обновление:** 2026-01-07

## Контекст

Платформа Collabverse должна поддерживать работу пользователей в нескольких организациях и workspace. Это необходимо для:

- **Агентств:** Управление множеством клиентских проектов в разных организациях
- **Фрилансеров:** Работа с несколькими клиентами одновременно
- **Компаний:** Разделение внутренних проектов по отделам/командам

Существовали следующие варианты модели данных:

1. **Плоская модель:** Пользователь → Проекты (без организаций)
2. **Одноуровневая модель:** Пользователь → Организации → Проекты
3. **Двухуровневая модель:** Пользователь → Организации → Workspaces → Проекты

Требования:
- Пользователь может состоять в нескольких организациях
- Организация может содержать несколько workspace
- Проект принадлежит workspace
- Изоляция данных между организациями и workspace
- Гибкая система ролей и прав доступа

## Решение

**Целевое состояние: использовать двухуровневую модель Organizations + Workspaces с ограничениями по подписке.**

### Детали решения (целевое состояние)

1. **Модель данных:**
   ```text
   User
   ├── Organization (организация)
   │   ├── Workspace (рабочее пространство)
   │   │   └── Project (проект)
   │   └── Workspace
   └── Organization
   ```

2. **Основные сущности:**
   - **`organizations`** — организации (компании, команды)
   - **`workspaces`** — рабочие пространства внутри организаций (планируется)
   - **`organization_members`** — связь пользователей с организациями (роли: owner, admin, member, viewer)
   - **`workspace_members`** — связь пользователей с workspace (планируется)
   - **`pm_projects`** — проекты, принадлежащие workspace через `workspace_id`

3. **Роли и права:**
   - **Роль в организации:** определяет доступ к workspace и проектам организации
   - **Роль в проекте:** определяет доступ к задачам и ресурсам проекта
   - **Наследование прав:** роль в организации влияет на доступ к workspace

4. **Переключение контекста:**
   - **Organization Context:** `OrganizationContext` определяет активную организацию
   - **Switching:** Переключение через `OrganizationSwitcher` компонент
   - **Session:** Активная организация хранится в сессии и Zustand store

5. **Ограничения подписок:**
   - **Free plan:** 1 организация (частично реализовано через `user_subscription.max_organizations`)
   - **Pro/Max plan:** Неограниченное количество организаций

### Текущее состояние (реализовано частично)

- **Organizations:** Таблицы `organization` и `organization_member` уже в БД
- **Подписка:** Таблица `user_subscription` хранит лимиты по организациям
- **Workspaces:** Используется `workspace_id` в `pm_*` таблицах без отдельной таблицы workspace
- **NEEDS_CONFIRMATION:** Хранение membership workspace и план миграции в БД

### Пример структуры данных

```typescript
// Пользователь
interface User {
  id: string;
  email: string;
  // ...
}

// Организация
interface Organization {
  id: string;
  name: string;
  primaryOwnerId: string;
}

// Workspace
interface Workspace {
  id: string;
  organizationId: string;
  label: string;
}

// Связь пользователя с организацией
interface OrganizationMember {
  organizationId: string;
  userId: string;
  role: 'owner' | 'admin' | 'member' | 'viewer';
  isPrimary: boolean; // Первая созданная организация = primary
}

// Проект принадлежит workspace
interface Project {
  id: string;
  workspaceId: string; // FK на workspaces (целевое состояние)
  ownerId: string;
  // ...
}
```

## Последствия

### Положительные

- ✅ **Гибкость:** Пользователь может работать в нескольких организациях одновременно
- ✅ **Изоляция данных:** Данные изолированы по организациям и workspace
- ✅ **Масштабируемость:** Легко добавлять новые организации и workspace
- ✅ **Роли:** Гибкая система ролей на разных уровнях (организация, проект)
- ✅ **Монетизация:** Ограничения подписок для free/pro/max планов

### Отрицательные

- ⚠️ **Сложность:** Сложнее управление правами доступа при нескольких организациях
- ⚠️ **Производительность:** Дополнительные JOIN при запросах для фильтрации по организации
- ⚠️ **UX:** Пользователю нужно переключаться между организациями
- ⚠️ **Миграция:** Существующие данные требуют миграции для поддержки мультиаккаунта

### Митигация

- **Четкая модель ролей:** Документированные роли и права на каждом уровне
- **Проверка прав:** Проверка прав доступа на каждом уровне (API, UI)
- **Индексы БД:** Индексы на `organization_id` и `workspace_id` для производительности
- **UI индикаторы:** Показ активной организации в UI для ясности

**NEEDS_CONFIRMATION:**
- [ ] Схема таблиц workspaces/workspace_members и миграция данных
- [ ] Гранулярные лимиты подписок (workspace, проекты, участники)

## Альтернативы

### Альтернатива 1: Плоская модель

**Рассмотрено:** Пользователь → Проекты (без организаций).

**Отклонено:** Не поддерживает работу в нескольких организациях. Нет изоляции данных между клиентами.

### Альтернатива 2: Одноуровневая модель

**Рассмотрено:** Пользователь → Организации → Проекты (без workspace).

**Отклонено:** Недостаточно гибкости для разделения проектов внутри организации. Workspace позволяет группировать проекты по командам/отделам.

### Альтернатива 3: Трехуровневая модель

**Рассмотрено:** Пользователь → Организации → Workspaces → Teams → Проекты.

**Отклонено:** Слишком сложно для текущих требований. Двухуровневая модель достаточно гибкая.

## Связанные документы

- [`../../platform/roles-permissions.md`](../../platform/roles-permissions.md) - роли и права доступа
- [`../../modules/projects-tasks/projects-tasks-access.md`](../../modules/projects-tasks/projects-tasks-access.md) - модель доступа PM Core
- [`../../../CONTINUITY.md`](../../../CONTINUITY.md) - информация о multi-org feature
- [`../../../apps/api/src/repositories/organizations-repository.ts`](../../../apps/api/src/repositories/organizations-repository.ts) - репозиторий организаций
- [`../../../apps/api/src/repositories/workspaces-repository.ts`](../../../apps/api/src/repositories/workspaces-repository.ts) - текущая in-memory реализация workspace
- [`../arc42.md`](../arc42.md#8-cross-cutting-concepts) - Cross-cutting Concepts с описанием мультиаккаунта
