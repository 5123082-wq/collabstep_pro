# ADR-0004: WebSocket для real-time обновлений

**Статус:** Принято  
**Дата:** 2026-01-07  
**Владелец:** engineering  
**Авторы:** Architecture Documentation  
**Последнее обновление:** 2026-01-07

## Контекст

Платформа Collabverse требует real-time синхронизации состояния между клиентами. При изменении задач, комментариев, уведомлений, сообщений в чате все подключенные клиенты должны видеть изменения мгновенно.

Существовали следующие варианты решения:

1. **Polling** — периодические запросы к API для проверки обновлений
2. **Server-Sent Events (SSE)** — односторонняя передача данных от сервера к клиенту
3. **WebSocket** — двусторонняя связь между клиентом и сервером
4. **Long Polling** — длинные HTTP запросы с ожиданием обновлений

Требования:
- Мгновенные обновления при изменениях
- Минимальная нагрузка на сервер
- Надежность при сетевых проблемах
- Простота реализации и поддержки

## Решение

**Использовать WebSocket с fallback на polling для real-time синхронизации состояния между клиентами.**

### Детали решения

1. **WebSocket сервер:**
   - Отдельный процесс на порту 8080
   - Протокол: Socket.io для совместимости и переподключения
   - Комнаты проектов: каждый проект имеет свою комнату для событий
   - События: `task.created`, `task.updated`, `comment.added`, `chat.message`, `notification.new`

2. **Fallback на polling:**
   - Автоматический переход на polling при недоступности WebSocket сервера
   - Примеры интервалов:
     - Чат: каждые 30 секунд (`ProjectChat`)
     - Уведомления: каждые 60 секунд (`useUnreadNotifications`)
     - Другие компоненты: по потребности модуля (NEEDS_CONFIRMATION)

3. **Клиентская реализация:**
   - React hooks: `useWebSocket()`, `useProjectEvents()`
   - Автоматическое переподключение при разрыве соединения
   - Экспоненциальная задержка между попытками переподключения

4. **Синхронизация состояния:**
   - При получении события WebSocket обновляется локальное состояние
   - UI автоматически перерисовывается через React
   - Оптимистичное обновление при действиях пользователя

### Пример использования

```typescript
useProjectEvents(projectId, userId, 'task.updated', (event) => {
  // Обработать event.data и обновить локальное состояние
});
```

## Последствия

### Положительные

- ✅ **Мгновенные обновления:** Изменения видны всем клиентам мгновенно
- ✅ **Эффективность:** Меньше HTTP запросов по сравнению с polling
- ✅ **Надежность:** Автоматическое переподключение при разрыве соединения
- ✅ **Гибкость:** Fallback на polling позволяет системе работать без WebSocket сервера
- ✅ **Масштабируемость:** Можно масштабировать WebSocket сервер отдельно

### Отрицательные

- ⚠️ **Сложность:** Требуется отдельный WebSocket сервер и управление соединениями
- ⚠️ **Инфраструктура:** Дополнительный процесс для запуска и мониторинга
- ⚠️ **Проблемы с сетью:** WebSocket может быть заблокирован некоторыми прокси/firewall
- ⚠️ **Память:** Каждое соединение занимает память на сервере

### Митигация

- **Fallback на polling:** Система работает даже без WebSocket сервера
- **Автоматическое переподключение:** Клиент автоматически переподключается при разрыве
- **Мониторинг:** Логирование подключений и событий для диагностики
- **Graceful degradation:** Плавный переход между WebSocket и polling режимами

## Альтернативы

### Альтернатива 1: Polling

**Рассмотрено:** Периодические запросы к API для проверки обновлений.

**Отклонено:** Создает большую нагрузку на сервер при частых запросах. Задержка в обновлениях зависит от интервала polling.

### Альтернатива 2: Server-Sent Events (SSE)

**Рассмотрено:** Односторонняя передача данных от сервера к клиенту.

**Отклонено:** Не поддерживает двустороннюю связь, требуется отдельный HTTP запрос для отправки данных. WebSocket более гибкий.

### Альтернатива 3: Long Polling

**Рассмотрено:** Длинные HTTP запросы с ожиданием обновлений.

**Отклонено:** Сложнее в реализации и поддержке. WebSocket более эффективен и стандартизирован.

## Связанные документы

- [`../../modules/projects-tasks/projects-tasks-websocket.md`](../../modules/projects-tasks/projects-tasks-websocket.md) - документация WebSocket модуля PM Core
- [`../../archive/2026-01-07-pm-core-migration/plans/projects-implementation-plan.md`](../../archive/2026-01-07-pm-core-migration/plans/projects-implementation-plan.md) - Stage L: WebSocket реализация (архив)
- [`../arc42.md`](../arc42.md#6-runtime-view) - Runtime View с описанием потоков WebSocket
- [`../../../apps/web/lib/websocket/hooks.ts`](../../../apps/web/lib/websocket/hooks.ts) - React hooks для WebSocket
